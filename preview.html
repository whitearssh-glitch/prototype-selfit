<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SELFit – Preview</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet" />
  <style>
    @font-face {
      font-family: 'ARCO';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url('https://db.onlinewebfonts.com/t/e31fd2ef9bcf0adbb98de3b059d2b88a.woff2') format('woff2');
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    html { background: linear-gradient(135deg, #ffb6c1 0%, #ffc0cb 40%, #ffe4ec 100%); }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #ffb6c1 0%, #ffc0cb 40%, #ffe4ec 100%);
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100%;
      overflow-x: auto;
    }
    .app {
      display: flex;
      flex-direction: column;
      width: 414px;
      min-width: 414px;
      max-width: 100%;
      min-height: 100%;
      max-height: 844px;
      margin: 0 auto;
      padding: 0.75rem;
      background: linear-gradient(135deg, #ffb6c1 0%, #ffc0cb 40%, #ffe4ec 100%);
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.06);
      flex-shrink: 0;
    }
    @media (min-height: 800px) {
      .app { min-height: 667px; border-radius: 1.25rem; }
    }
    .app.app--step3-colors {
      background: linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%) !important;
      border: 6px solid #5c6bc0 !important;
    }
    /* Header – no color box; text + divider only */
    .app-header {
      position: relative;
      width: 100%;
      min-width: 0;
      font-size: 0.9rem;
      font-weight: bold;
      padding: 0.5rem 1rem;
      flex-shrink: 0;
      text-align: center;
      box-sizing: border-box;
      background: none;
    }
    .app-header-text {
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .app-header::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 1.5px;
      background: linear-gradient(90deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      border-radius: 2px;
    }
    /* Step 3 theme: header text + divider */
    .app-header.app-header--step3 .app-header-text {
      background: linear-gradient(135deg, #9fa8da 0%, #5c6bc0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .app-header.app-header--step3::after {
      background: linear-gradient(90deg, #9fa8da 0%, #5c6bc0 100%);
    }
    .app-content { position: relative; flex: 1; min-height: 0; display: flex; flex-direction: column; }
    .app-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .app-overlay > * { pointer-events: auto; }
    .corner-select-screen {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ffb6c1 0%, #ffc0cb 40%, #ffe4ec 100%);
      border: 6px solid #ad1457;
      border-radius: inherit;
      box-sizing: border-box;
    }
    .corner-select-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.25rem;
    }
    .corner-select-btn {
      min-width: 10rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 1rem;
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: filter 0.15s ease;
    }
    .corner-select-btn:hover { filter: brightness(1.08); }
    .corner-select-btn--step3 {
      background: linear-gradient(135deg, #f8bbd0 0%, #e1bee7 35%, #9fa8da 65%, #5c6bc0 100%);
    }
    .corner-intro-screen {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ffb6c1 0%, #ffc0cb 40%, #ffe4ec 100%);
      border: 6px solid #ad1457;
      border-radius: inherit;
      box-sizing: border-box;
      cursor: pointer;
    }
    .corner-intro-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }
    .corner-intro-step {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.75rem;
      border-radius: 0.75rem;
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
    }
    .corner-intro-title {
      margin: 0;
      font-size: 2.75rem;
      font-weight: 700;
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 40%, #d81b60 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-align: center;
      letter-spacing: 0.02em;
    }
    .corner-intro-screen--step3 {
      background: linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%);
      border-color: #5c6bc0;
    }
    .corner-intro-screen--step3 .corner-intro-step {
      background: linear-gradient(135deg, #e1bee7 0%, #7986cb 100%);
    }
    .corner-intro-screen--step3 .corner-intro-title {
      background: linear-gradient(135deg, #9fa8da 0%, #5c6bc0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .screen-content--step3-colors {
      flex: 1;
      min-height: 0;
      background: linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%);
      border: 6px solid #5c6bc0;
      border-radius: inherit;
      box-sizing: border-box;
    }
    .topic-box--step3 {
      background: linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%);
      color: #37474f;
      font-weight: 600;
    }
    .topic-box {
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      border: none;
      font-size: 0.9rem;
      color: #fff;
      text-align: center;
      align-self: center;
      margin-bottom: 0.75rem;
      flex-shrink: 0;
    }
    .screen-content {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 0;
      width: 100%;
    }
    .screen-center {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 0;
      width: 100%;
      padding-top: 0.5rem;
    }
    .screen-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      min-height: 320px;
      width: 100%;
    }
    .screen-main--vertical-center { justify-content: center; }
    .screen-bottom {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
      width: 100%;
      margin-top: 0.5rem;
      padding-bottom: 0.5rem;
      flex-shrink: 0;
    }
    .screen-next {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .screen-next--top-right {
      position: absolute;
      top: -0.5rem;
      right: 0;
    }
    .text-box {
      width: 100%;
      max-width: 28rem;
      margin: 0 auto;
      padding: 1rem 1.25rem;
      border-radius: 1.75rem;
      border: 2px solid transparent;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%) border-box;
      background-origin: border-box;
      background-clip: padding-box, border-box;
      font-size: 1.1rem;
      line-height: 1.5;
      text-align: center;
      white-space: pre-line;
      box-sizing: border-box;
    }
    .text-box-two-lines { display: flex; flex-direction: column; gap: 0.25rem; }
    .text-box-two-lines .text-box-line {
      display: block;
      font-weight: bold;
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .main-text {
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
      padding: 1rem;
    }
    .main-text--two-lines { margin: 0; padding: 0 1rem; line-height: 1.2; }
    .main-text.main-text--sub { font-size: 1.1rem; color: #666; margin-top: -0.2em; }
    .main-text-blank-box {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 4rem;
      height: 1.4em;
      margin-left: 0.2em;
      padding: 0 0.4em;
      vertical-align: middle;
      border: 2px solid rgba(255, 255, 255, 0.9);
      border-radius: 0.5rem;
      background: rgba(255, 255, 255, 0.95);
      box-sizing: border-box;
    }
    .main-text-blank-box__hint {
      color: #aaa;
      font-size: inherit;
      font-weight: inherit;
    }
    .main-text-fill--cyan {
      background: linear-gradient(135deg, #26c6da 0%, #5c6bc0 50%, #7e57c2 100%);
      background-repeat: no-repeat;
      background-position: 0 0;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: main-text-gradient-fill 1.4s ease-out forwards;
    }
    .main-text--gradient-sequential {
      background: linear-gradient(90deg, #880e4f 0%, #ad1457 20%, #d81b60 40%, #26c6da 40%, #5c6bc0 70%, #7e57c2 100%);
      background-repeat: no-repeat;
      background-position: 0 0;
      background-size: 0% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: main-text-gradient-fill 1.4s ease-out forwards;
    }
    .speed-display {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.25rem;
      width: 100%;
      padding: 0 0.5rem 0.25rem;
      margin-bottom: 0.25rem;
      flex-shrink: 0;
    }
    .speed-display-item {
      font-size: 0.7rem;
      font-weight: 600;
      color: #880e4f;
      padding: 0.2rem 0.5rem;
      border-radius: 0.4rem;
      background: rgba(255, 255, 255, 0.7);
    }
    .speed-display-item--slow {
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      color: #fff;
    }
    .speed-display--fast-active .speed-display-item--slow {
      background: #fff;
      color: #880e4f;
    }
    .speed-display--fast-active .speed-display-item--fast {
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      color: #fff;
    }
    .speed-display-sep { font-size: 0.65rem; color: #ad1457; opacity: 0.8; }
    .main-text--gradient {
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      background-repeat: no-repeat;
      background-position: 0 0;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: main-text-gradient-fill 1.4s ease-out forwards;
    }
    @keyframes main-text-gradient-fill {
      from { background-size: 0% 100%; }
      to { background-size: 100% 100%; }
    }
    .teacher-image {
      max-width: 320px;
      max-height: 400px;
      width: 100%;
      object-fit: contain;
    }
    .teacher-image--shake {
      animation: teacher-shake 1.2s ease-in-out infinite;
    }
    @keyframes teacher-shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }
    .screen1-tap-hint {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #888;
      text-align: center;
    }
    .next-btn {
      padding: 0.35rem 0.75rem;
      border: none;
      border-radius: 0.55rem;
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      color: #fff;
      font-size: 0.72rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.15em;
      flex-shrink: 0;
    }
    .next-btn:hover:not(:disabled) { filter: brightness(1.05); }
    .next-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .mic-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 12px rgba(173, 20, 87, 0.35);
      transition: transform 0.15s ease;
    }
    .mic-btn:hover { transform: scale(1.05); }
    .mic-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .mic-btn svg { width: 28px; height: 28px; }
    .checkmark-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      0% { transform: translate(-50%, -50%) scale(0); }
      70% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    .checkmark-popup svg { width: 48px; height: 48px; color: #2e7d32; }
    .roleplay-complete-popup svg { width: 48px; height: 48px; color: #7986cb; }
    .wrong-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pop 0.3s ease;
    }
    .wrong-popup svg { width: 48px; height: 48px; color: #c62828; }
    .stt-debug-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 6px 10px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      font-size: 11px;
      font-family: monospace;
      z-index: 9999;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .speed-up-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      padding: 1rem 1.5rem;
      border-radius: 1rem;
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 50%, #d81b60 100%);
      color: #fff;
      font-size: 1.25rem;
      font-weight: 700;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      animation: pop 0.3s ease;
      pointer-events: auto;
    }

    /* Screen 7 only: Good! stamp popup when Next is clicked */
    .screen7-stamp-popup {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      cursor: pointer;
      animation: screen7-stamp-pop 0.4s ease-out;
    }
    /* Index 24: GOOD stamp as full-screen overlay (above everything) */
    .screen7-stamp-popup--overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
    }
    @keyframes screen7-stamp-pop {
      0% { opacity: 0; transform: scale(0.5); }
      70% { transform: scale(1.08); }
      100% { opacity: 1; transform: scale(1); }
    }
    .screen7-stamp-circle {
      width: 138px;
      height: 138px;
      border-radius: 50%;
      background: linear-gradient(135deg, #5a0a35 0%, #8b1045 35%, #b81a52 65%, #e91e63 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .screen7-stamp-svg { width: 100%; height: 100%; }
    .screen7-stamp-text {
      font-family: 'ARCO', sans-serif;
      font-size: 26px;
      font-weight: normal;
    }

    /* Index 26: Role Play – Step 3 mic, 5-segment progress, chat bubbles */
    .mic-btn--step3 {
      background: linear-gradient(135deg, #e1bee7 0%, #7986cb 50%, #5c6bc0 100%);
      box-shadow: 0 2px 12px rgba(92, 107, 192, 0.35);
    }
    .roleplay-layout { flex: 1; display: flex; flex-direction: column; min-height: 0; width: 100%; }
    /* Topic row: centered. Progress row: same position as Step 2 slow/fast (right-aligned) */
    .roleplay-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.25rem 0.5rem 0.5rem;
      flex-shrink: 0;
    }
    .roleplay-progress-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
      padding: 0 0.5rem 0.25rem;
      margin-bottom: 0.25rem;
      flex-shrink: 0;
    }
    .roleplay-progress {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .roleplay-progress-segment {
      width: 24px;
      height: 8px;
      border-radius: 4px;
      background: rgba(92, 107, 192, 0.3);
      transition: background 0.2s ease;
    }
    .roleplay-progress-segment.roleplay-progress-segment--filled {
      background: linear-gradient(135deg, #9fa8da 0%, #5c6bc0 100%);
    }
    .roleplay-chat {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      min-height: 0;
      background: linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%);
    }
    .roleplay-chat--tap-to-listen { cursor: pointer; }
    .roleplay-tap-hint { font-size: 0.8em; color: #5c6bc0; opacity: 0.85; font-weight: normal; }
    .roleplay-bubble-row { display: flex; align-items: flex-start; gap: 0.5rem; }
    .roleplay-bubble-row--character { justify-content: flex-start; }
    .roleplay-bubble-row--student { justify-content: flex-end; flex-direction: row-reverse; align-self: flex-end; width: 100%; max-width: 100%; box-sizing: border-box; }
    .roleplay-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    .roleplay-bubble-wrap { display: flex; flex-direction: column; align-items: flex-start; max-width: 80%; }
    .roleplay-bubble-row--student .roleplay-bubble-wrap { align-items: flex-end; text-align: right; flex: 1; min-width: 0; max-width: calc(100% - 3rem); }
    .roleplay-name { font-size: 0.7rem; font-weight: 600; color: #37474f; margin-bottom: 2px; }
    .roleplay-bubble {
      padding: 0.5rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.95rem;
      white-space: pre-line;
    }
    .roleplay-bubble--single-line {
      white-space: nowrap;
    }
    .roleplay-bubble-row--student .roleplay-bubble-wrap--single-line {
      min-width: 0;
      max-width: calc(100% - 3rem);
    }
    .roleplay-bubble--character {
      background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
      color: #283593;
      border-bottom-left-radius: 4px;
    }
    .roleplay-bubble--student {
      background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 50%, #283593 100%);
      color: #fff;
      border-bottom-right-radius: 4px;
      min-height: 2rem;
      width: fit-content;
      max-width: 100%;
      white-space: pre-wrap;
      box-sizing: border-box;
    }
    .roleplay-choices { display: flex; flex-direction: column; gap: 0.35rem; margin-top: 0.5rem; align-items: flex-end; }
    .roleplay-choice {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      background: rgba(92, 107, 192, 0.15);
      color: #37474f;
      border: 1px solid rgba(92, 107, 192, 0.4);
    }
    .roleplay-choice-btn { cursor: pointer; font: inherit; text-align: inherit; width: 100%; }
    .roleplay-choice-btn:hover { background: rgba(92, 107, 192, 0.25); border-color: rgba(92, 107, 192, 0.6); }
    .roleplay-feedback {
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.75rem;
      background: rgba(255, 235, 59, 0.25);
      border: 1px solid rgba(255, 193, 7, 0.6);
      font-size: 0.85rem;
      color: #5d4037;
    }
    .roleplay-feedback-suggestion { margin-top: 0.35rem; font-weight: 600; color: #5c6bc0; }
    .roleplay-retry-btn {
      margin-top: 0.5rem;
      padding: 0.35rem 0.75rem;
      border-radius: 0.5rem;
      border: none;
      background: linear-gradient(135deg, #9fa8da 0%, #5c6bc0 100%);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }
    .roleplay-bottom { flex-shrink: 0; padding: 0.75rem; display: flex; justify-content: center; align-items: center; }
    .roleplay-bubble-actions { display: flex; align-items: center; gap: 0.35rem; margin-top: 0.25rem; flex-shrink: 0; }
    .roleplay-k-btn {
      width: 1.75rem; height: 1.75rem; padding: 0; display: inline-flex; align-items: center; justify-content: center;
      color: #5c6bc0; background: rgba(92, 107, 192, 0.12); border: 1px solid rgba(92, 107, 192, 0.35);
      border-radius: 50%; cursor: pointer; flex-shrink: 0;
    }
    .roleplay-bubble-actions .roleplay-k-btn { margin-top: 0; }
    .roleplay-k-btn svg { width: 1rem; height: 1rem; }
    .roleplay-k-btn:hover { background: rgba(92, 107, 192, 0.2); color: #3949ab; }
    .roleplay-chat-bottom { display: flex; justify-content: center; padding: 1rem 0 0.5rem; flex-shrink: 0; }
    .roleplay-check-btn {
      display: flex; align-items: center; justify-content: center;
      width: 56px; height: 56px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, #5c6bc0 0%, #7986cb 40%, #9fa8da 100%);
      color: #fff; cursor: pointer;
      box-shadow: 0 2px 12px rgba(92, 107, 192, 0.4);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .roleplay-check-btn:hover { transform: scale(1.05); box-shadow: 0 4px 16px rgba(92, 107, 192, 0.5); }
    .roleplay-check-btn:active { transform: scale(0.98); }
    .roleplay-check-btn svg { width: 28px; height: 28px; }
    .topic-box--step3 {
      background: linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%);
      color: #37474f;
      font-weight: 600;
    }
    .screen-content--step3-no-frame,
    .screen-content--step3-colors-no-frame {
      flex: 1;
      min-height: 0;
      background: linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%);
      border: none;
      border-radius: inherit;
      box-sizing: border-box;
    }
    .realtalk-layout { flex: 1; display: flex; flex-direction: column; min-height: 0; width: 100%; }
    .realtalk-top { display: flex; flex-direction: column; align-items: center; padding: 0.25rem 0.5rem 0.5rem; flex-shrink: 0; }
    .realtalk-text-slot { flex-shrink: 0; min-height: 2.8em; line-height: 1.4; font-size: 1rem; padding: 0.25rem 0.75rem; text-align: center; width: 100%; box-sizing: border-box; }
    .realtalk-text-slot--above { padding-bottom: 0.35rem; }
    .realtalk-text-slot--below { padding-top: 0.35rem; }
    .realtalk-main { flex: 1; min-height: 0; width: 100%; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .realtalk-main-image { width: 100%; max-width: min(85vw, 22rem); height: auto; max-height: 60vh; object-fit: contain; display: block; }
    .realtalk-layout--with-text-slots .realtalk-main-image { max-width: min(78vw, 19rem); max-height: 42vh; }
    .realtalk2-layout { flex: 1; display: flex; flex-direction: column; min-height: 0; width: 100%; }
    .realtalk2-slot-two-lines { flex-shrink: 0; height: 3.2rem; padding: 0.15rem 0.75rem; text-align: center; display: flex; align-items: center; justify-content: center; width: 100%; box-sizing: border-box; }
    .realtalk2-text-above, .realtalk2-text-below { flex-shrink: 0; width: 100%; box-sizing: border-box; }
    .realtalk2-text-placeholder { display: inline-block; min-height: 1.4em; }
    .realtalk-guide { display: flex; flex-direction: column; align-items: stretch; max-width: 48rem; padding: 0; overflow: hidden; background: rgba(255,255,255,0.85); border-radius: 1.25rem; border: 2px solid rgba(92,107,192,0.4); box-shadow: 0 4px 12px rgba(92,107,192,0.2); }
    .realtalk-guide-header { padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #5c6bc0 0%, #7986cb 100%); text-align: center; }
    .realtalk-guide-title { margin: 0; font-size: 1rem; font-weight: 700; color: #fff; }
    .realtalk-guide-divider { height: 0; border-bottom: 2px solid rgba(92,107,192,0.5); flex-shrink: 0; }
    .realtalk-guide-content { display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 1.5rem; }
    .realtalk-guide-avatar { width: 5rem; height: 5rem; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    .realtalk-guide-text { margin: 0; width: 100%; text-align: center; }
    .realtalk-guide-text-line { margin: 0 0 0.25rem; font-size: 0.95rem; line-height: 1.3; color: #3949ab; }
    .realtalk-guide-text-line:last-child { margin-bottom: 0; }
    .realtalk-bottom { flex-shrink: 0; padding: 1rem; display: flex; justify-content: center; align-items: center; }
    .realtalk-layout--reserve-go-space .realtalk-bottom { min-height: 3.5rem; }
    .realtalk-go-btn { padding: 0.75rem 2rem; font-size: 1.1rem; font-weight: 700; color: #fff; background: linear-gradient(135deg, #5c6bc0 0%, #7986cb 100%); border: none; border-radius: 2rem; cursor: pointer; box-shadow: 0 2px 8px rgba(92,107,192,0.4); }
    .realtalk-go-btn:hover { background: linear-gradient(135deg, #7986cb 0%, #9fa8da 100%); box-shadow: 0 4px 12px rgba(92,107,192,0.5); }
    .realtalk-go-btn--hidden { visibility: hidden; pointer-events: none; }
    .realtalk-mic37--hidden { visibility: hidden; pointer-events: none; }
    .realtalk2-mic--hidden { visibility: hidden; pointer-events: none; }
    .realtalk2-bottom--fixed-height { min-height: 3.5rem; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header" id="app-header"><span class="app-header-text">Basic 01 Day 01</span></header>
    <div class="app-content" id="app-content"></div>
  </div>
  <div id="app-overlay" class="app-overlay"></div>

  <script>
    var CORNER_TITLE = 'Patterns';
    var CORNER_STEP_2 = 'STEP 2';
    var CORNER_TITLE_2 = 'Speed Up';
    var CORNER_STEP_3 = 'STEP 3';
    var CORNER_TITLE_3 = 'Role Play';
    const CENTER_TEXT_S2 = 'Hello, SELENA!';
    const CENTER_TEXT_S4 = 'Nice to meet you!';
    const CENTER_TEXT_S6 = 'I am';
    const CENTER_TEXT_S9_LINE1 = 'Nice to meet you!';
    const CENTER_TEXT_S9_LINE2 = '만나서 반가워요!';
    var SCREEN9_AUDIO = './nice-to-meet-you.mp3';
    const CENTER_TEXT_S10_LINE1 = 'Nice to meet you!';
    const CENTER_TEXT_S10_LINE2 = '만나서 반가워요!';
    var SCREEN10_AUDIO = './nice-to-meet-you.mp3';
    const CENTER_TEXT_S11_LINE1 = 'I am';
    const CENTER_TEXT_S11_LINE2 = '나는 ~예요, 해요';
    var SCREEN11_AUDIO = './i-am.mp3';
    const CENTER_TEXT_S12_LINE1 = 'I am';
    const CENTER_TEXT_S12_LINE2 = '나는 ~예요, 해요';
    const CENTER_TEXT_S13_LINE1_PREFIX = 'I am ';
    const CENTER_TEXT_S13_FILL = 'happy';
    const CENTER_TEXT_S13_LINE2 = '나는 행복해요.';
    var SCREEN13_AUDIO = './i-am-happy.mp3';
    const CENTER_TEXT_S15_LINE1_PREFIX = 'I am ';
    const CENTER_TEXT_S15_FILL = 'happy';
    const CENTER_TEXT_S15_LINE2 = '나는 행복해요.';
    var SCREEN15_AUDIO = './i-am-happy.mp3';
    const CENTER_TEXT_S16_LINE1_PREFIX = 'I am ';
    const CENTER_TEXT_S16_FILL = 'a student';
    const CENTER_TEXT_S16_LINE2 = '나는 학생이에요.';
    var SCREEN16_AUDIO = './i-am-a-student.mp3';
    const CENTER_TEXT_S17_LINE1_PREFIX = 'I am ';
    const CENTER_TEXT_S17_FILL = 'a student';
    const CENTER_TEXT_S17_LINE2 = '나는 학생이에요.';
    const CENTER_TEXT_S18_LINE1_PREFIX = 'I am ';
    const CENTER_TEXT_S18_FILL = 'Peter';
    const CENTER_TEXT_S18_LINE2 = '나는 피터예요.';
    var TEXT_BOX_LINE1 = 'Hello, everyone!';
    var TEXT_BOX_LINE2 = 'Welcome to SELFit!';

    function renderCornerSelect() {
      return (
        '<div class="corner-select-screen">' +
          '<div class="corner-select-inner">' +
            '<button type="button" class="corner-select-btn" id="btn-step1" aria-label="STEP 1 Patterns">STEP 1</button>' +
            '<button type="button" class="corner-select-btn" id="btn-step2" aria-label="STEP 2 Speed Up">STEP 2</button>' +
            '<button type="button" class="corner-select-btn corner-select-btn--step3" id="btn-step3" aria-label="STEP 3 Role Play">STEP 3</button>' +
            '<button type="button" class="corner-select-btn corner-select-btn--step3" id="btn-realtalk2" aria-label="Real Talk 2">Real Talk 2</button>' +
          '</div>' +
        '</div>'
      );
    }

    function renderCornerIntro(step, title, step3) {
      step = step || 'STEP 1';
      title = title || CORNER_TITLE;
      var screenClass = 'corner-intro-screen' + (step3 ? ' corner-intro-screen--step3' : '');
      return (
        '<div class="' + screenClass + '" id="corner-intro-screen">' +
          '<div class="corner-intro-inner">' +
            '<span class="corner-intro-step">' + step + '</span>' +
            '<h1 class="corner-intro-title">' + title + '</h1>' +
          '</div>' +
        '</div>'
      );
    }

    function playDingDong() {
      try {
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, start, duration) {
          var osc = ctx.createOscillator();
          var gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.2, start);
          gain.gain.exponentialRampToValueAtTime(0.01, start + duration);
          osc.start(start);
          osc.stop(start + duration);
        }
        playTone(523, 0, 0.15);
        playTone(659, 0.2, 0.2);
      } catch (e) {}
    }

    function playNotificationSound() {
      try {
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 880;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.25, 0);
        gain.gain.exponentialRampToValueAtTime(0.01, 0.1);
        osc.start(0);
        osc.stop(0.1);
      } catch (e) {}
    }

    var TOPIC_TEXT = 'TOPIC: Self-introduction';
    var SCREEN1_AUDIO = ['./screen1-1.mp3', './screen1-2.mp3'];
    var screen1State = { audioStarted: false, audioEnded: false, isPlaying: false, index: 0 };
    var SCREEN3_AUDIO = ['./screen3-1.mp3', './screen3-2.mp3', './screen3-3.mp3'];
    var screen3State = { audioStarted: false, audioEnded: false, isPlaying: false, index: 0 };
    var TEXT_BOX_S3_LINE1 = 'Nice to meet you!';
    var TEXT_BOX_S3_LINE2 = '만나서 반가워요!';
    var SCREEN5_AUDIO = ['./screen5-1.mp3', './screen5-2.mp3', './screen5-3.mp3'];
    var screen5State = { audioStarted: false, audioEnded: false, isPlaying: false, index: 0 };
    var TEXT_BOX_S5_LINE1 = 'I am';
    var TEXT_BOX_S5_LINE2 = '나는 ~예요, ~해요';
    var SCREEN7_AUDIO = ['./screen7-1.mp3', './screen7-2.mp3'];
    var screen7State = { audioStarted: false, audioEnded: false, isPlaying: false, index: 0, nextClicked: false, showStampPopup: false };
    var TEXT_BOX_S7_LINE1 = "Let's move on.";
    var TEXT_BOX_S7_LINE2 = 'Here we go!';

    function renderScreen1(state) {
      var audioStarted = state.audioStarted;
      var audioEnded = state.audioEnded;
      var isPlaying = state.isPlaying;
      var imgClass = 'teacher-image' + (isPlaying ? ' teacher-image--shake' : '');
      var tapHintHtml = '';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<img src="./ch.png" alt="Teacher" class="' + imgClass + '" />' +
              tapHintHtml +
            '</div>' +
            '<div class="screen-bottom">' +
              '<div class="text-box text-box-two-lines">' +
              '<span class="text-box-line">' + TEXT_BOX_LINE1 + '</span>' +
              '<span class="text-box-line">' + TEXT_BOX_LINE2 + '</span>' +
            '</div>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }

    // Screen 1: play screen1-1 then screen1-2 after user tap (browsers block autoplay)
    function playScreen1Next() {
      if (screen1State.index >= SCREEN1_AUDIO.length) {
        screen1State.isPlaying = false;
        screen1State.audioEnded = true;
        mount();
        setTimeout(goNext, 1200);
        return;
      }
      var audio = new Audio(SCREEN1_AUDIO[screen1State.index]);
      audio.onended = function () {
        screen1State.index++;
        playScreen1Next();
      };
      audio.onerror = function () {
        screen1State.index++;
        playScreen1Next();
      };
      screen1State.isPlaying = true;
      mount();
      var p = audio.play();
      if (p && typeof p.catch === 'function') p.catch(function () {});
    }

    function onScreen1Tap() {
      if (!screen1State.audioStarted) {
        screen1State.audioStarted = true;
        mount();
        playScreen1Next();
      }
    }

    function renderScreen3(state) {
      var audioStarted = state.audioStarted;
      var audioEnded = state.audioEnded;
      var isPlaying = state.isPlaying;
      var imgClass = 'teacher-image' + (isPlaying ? ' teacher-image--shake' : '');
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<img src="./ch.png" alt="Teacher" class="' + imgClass + '" />' +
            '</div>' +
            '<div class="screen-bottom">' +
              '<div class="text-box text-box-two-lines">' +
              '<span class="text-box-line">' + TEXT_BOX_S3_LINE1 + '</span>' +
              '<span class="text-box-line">' + TEXT_BOX_S3_LINE2 + '</span>' +
            '</div>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }

    function playScreen3Next() {
      if (screen3State.index >= SCREEN3_AUDIO.length) {
        screen3State.isPlaying = false;
        screen3State.audioEnded = true;
        mount();
        setTimeout(goNext, 1200);
        return;
      }
      var audio = new Audio(SCREEN3_AUDIO[screen3State.index]);
      audio.onended = function () {
        screen3State.index++;
        playScreen3Next();
      };
      audio.onerror = function () {
        screen3State.index++;
        playScreen3Next();
      };
      screen3State.isPlaying = true;
      mount();
      var p = audio.play();
      if (p && typeof p.catch === 'function') p.catch(function () {});
    }

    function onScreen3Tap() {
      if (!screen3State.audioStarted) {
        screen3State.audioStarted = true;
        mount();
        playScreen3Next();
      }
    }

    function renderScreen5(state) {
      var audioEnded = state.audioEnded;
      var isPlaying = state.isPlaying;
      var imgClass = 'teacher-image' + (isPlaying ? ' teacher-image--shake' : '');
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<img src="./ch.png" alt="Teacher" class="' + imgClass + '" />' +
            '</div>' +
            '<div class="screen-bottom">' +
              '<div class="text-box text-box-two-lines">' +
              '<span class="text-box-line">' + TEXT_BOX_S5_LINE1 + '</span>' +
              '<span class="text-box-line">' + TEXT_BOX_S5_LINE2 + '</span>' +
            '</div>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }

    function playScreen5Next() {
      if (screen5State.index >= SCREEN5_AUDIO.length) {
        screen5State.isPlaying = false;
        screen5State.audioEnded = true;
        mount();
        setTimeout(goNext, 1200);
        return;
      }
      var audio = new Audio(SCREEN5_AUDIO[screen5State.index]);
      audio.onended = function () {
        screen5State.index++;
        playScreen5Next();
      };
      audio.onerror = function () {
        screen5State.index++;
        playScreen5Next();
      };
      screen5State.isPlaying = true;
      mount();
      var p = audio.play();
      if (p && typeof p.catch === 'function') p.catch(function () {});
    }

    function onScreen5Tap() {
      if (!screen5State.audioStarted) {
        screen5State.audioStarted = true;
        mount();
        playScreen5Next();
      }
    }

    function renderScreen7(state) {
      var audioEnded = state.audioEnded;
      var nextClicked = state.nextClicked;
      var isPlaying = state.isPlaying;
      var showStampPopup = state.showStampPopup;
      var imgClass = 'teacher-image' + (isPlaying ? ' teacher-image--shake' : '');
      var stampPopupHtml = showStampPopup
        ? '<div class="screen7-stamp-popup" role="button" tabindex="0" aria-label="다음으로">' +
            '<div class="screen7-stamp-circle">' +
              '<svg class="screen7-stamp-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">' +
                '<defs><path id="stamp-small-star" d="M0 -2.1 L0.5 -0.5 L2.2 -0.5 L0.8 0.5 L1.3 2.1 L0 1.1 L-1.3 2.1 L-0.8 0.5 L-2.2 -0.5 L-0.5 -0.5 Z" fill="#fff"/></defs>' +
                '<circle cx="60" cy="60" r="52" fill="none" stroke="#fff" stroke-width="3"/>' +
                '<use href="#stamp-small-star" transform="translate(98, 38) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(82, 22) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(60, 16) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(38, 22) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(22, 38) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(22, 82) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(38, 98) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(60, 104) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(82, 98) scale(2)"/>' +
                '<use href="#stamp-small-star" transform="translate(98, 82) scale(2)"/>' +
                '<text x="60" y="62" text-anchor="middle" dominant-baseline="central" class="screen7-stamp-text" fill="#fff">GOOD!</text>' +
              '</svg>' +
            '</div>' +
          '</div>'
        : '';
      return (
        '<div class="screen-content">' +
          stampPopupHtml +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<img src="./ch.png" alt="Teacher" class="' + imgClass + '" />' +
            '</div>' +
            '<div class="screen-bottom">' +
              '<div class="text-box text-box-two-lines">' +
              '<span class="text-box-line">' + TEXT_BOX_S7_LINE1 + '</span>' +
              '<span class="text-box-line">' + TEXT_BOX_S7_LINE2 + '</span>' +
            '</div>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }

    function playScreen7Next() {
      if (screen7State.index >= SCREEN7_AUDIO.length) {
        screen7State.isPlaying = false;
        screen7State.audioEnded = true;
        mount();
        setTimeout(function () {
          screen7State.nextClicked = true;
          mount();
          setTimeout(function () {
            screen7State.showStampPopup = true;
            mount();
            try {
              var stampAudio = new Audio('./fb5.mp3');
              stampAudio.play().catch(function () {});
            } catch (err) {}
          }, 250);
        }, 1200);
        return;
      }
      var audio = new Audio(SCREEN7_AUDIO[screen7State.index]);
      audio.onended = function () {
        screen7State.index++;
        playScreen7Next();
      };
      audio.onerror = function () {
        screen7State.index++;
        playScreen7Next();
      };
      screen7State.isPlaying = true;
      mount();
      var p = audio.play();
      if (p && typeof p.catch === 'function') p.catch(function () {});
    }

    function onScreen7Tap() {
      if (!screen7State.audioStarted) {
        screen7State.audioStarted = true;
        mount();
        playScreen7Next();
      }
    }

    function renderScreen2(state, onNext) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;

      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';

      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';

      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<p class="main-text' + (state.isListening || state.recognitionDone ? ' main-text--gradient' : '') + '">' + CENTER_TEXT_S2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    function renderScreen4(state, onNext) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<p class="main-text' + (state.isListening || state.recognitionDone ? ' main-text--gradient' : '') + '">' + CENTER_TEXT_S4 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    function renderScreen6(state, onNext) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<p class="main-text' + (state.isListening || state.recognitionDone ? ' main-text--gradient' : '') + '">' + CENTER_TEXT_S6 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    var hash = window.location.hash.slice(1);
    var screenIndex = (hash === 'speed-up') ? 9 : (function () { var n = parseInt(hash, 10); return (!Number.isNaN(n) && n >= 0 && n <= 42) ? n : 0; })();
    // STT 디버그: 브라우저 Web Speech API 사용 (별도 서버 없음)
    window.__sttDebug = { api: 'Web Speech API (SpeechRecognition)', lastTranscript: '', lastScreenIndex: 0, onResultCount: 0, onEndFired: false };
    if (typeof console !== 'undefined' && console.log) console.log('SELFit preview 로드됨. STT 콘솔 로그 활성화 → 15·20번 화면에서 마이크 누르면 여기 찍힘');
    var screen2State = {
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen4State = {
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen6State = {
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var turn38ShowMic = false;
    var turn39Phase = 0;
    var turn39Playing = false;
    var turn39ShowModelText = false;
    var turn40Playing = false;
    var turn40ShowStamp = false;
    var turn41ShowBtn = false;
    var turn42ShowKo = [false, false, false, false, false, false, false, false, false];
    var turn42Script = [
      { speaker: 'Cathy', textEn: "Hi! I'm Cathy. What's your name?", textKo: '안녕! 난 캐시야. 네 이름은 뭐야?', audio: './realtalk1.mp3' },
      { speaker: 'Me', textEn: 'My name is Jake.', textKo: '내 이름은 제이크야.', audio: null },
      { speaker: 'Cathy', textEn: 'Oh, nice to meet you.', textKo: '오, 만나서 반가워.', audio: './real2.mp3' },
      { speaker: 'Me', textEn: 'Nice to meet you.', textKo: '만나서 반가워.', audio: null },
      { speaker: 'Cathy', textEn: 'Are you a student at this school?', textKo: '넌 이 학교의 학생이야?', audio: './real3.mp3' },
      { speaker: 'Me', textEn: 'I am a student.', textKo: '난 학생이야.', audio: null },
      { speaker: 'Cathy', textEn: 'Thanks for answering.\nHow are you feeling today?', textKo: '대답해줘서 고마워. 오늘 기분은 어때?', audio: './real5.mp3' },
      { speaker: 'Me', textEn: "I'm really hungry right now.", textKo: '난 지금 엄청 배가 고파.', audio: null, singleLine: true },
      { speaker: 'Cathy', textEn: "Haha. Me, too!\nLet's go eat something!", textKo: '하하. 나도야! 뭔가 먹으러 가자!', audio: './real7.mp3' }
    ];
    var screen9State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen10State = {
      recognitionDone: false,
      showCheckmark: false,
      showWrongMark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen11State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen12State = {
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen13State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen14State = {
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen15State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen16State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      showSpeedUpPopup: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen17State = {
      recognitionDone: false,
      showCheckmark: false,
      showGoodStamp: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen18State = {
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen20State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      showWrongMark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen21State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen22State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen23State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      isListening: false,
      checkmarkShown: false
    };
    var screen24State = {
      audioPlayed: false,
      recognitionDone: false,
      showCheckmark: false,
      showSpeedUpPopup: false,
      isListening: false,
      checkmarkShown: false
    };

    /* ===== Index 26 Role Play (React RolePlayScreen과 동기화) ===== */
    /* VoiceRSS TTS API (무료 350회/일) – https://www.voicerss.org/ 에서 키 발급 후 아래에 붙여넣기. 비우면 브라우저 TTS 사용 */
    var VOICERSS_API_KEY = '';

    var ROLEPLAY_CHARACTER_NAMES = ['Emma', 'Sophie', 'Lisa', 'Anna', 'Mary'];
    var ROLEPLAY_STUDENT_NAME = 'Me';
    var ROLEPLAY_CHOICES = ['Nice to meet you.', 'Good to see you.', 'Long time no see!'];
    var ROLEPLAY_TURN1_TEXT = "Hey! It's me!";
    var ROLEPLAY_TURN3_TEXT = 'Good to see you, too!';
    var ROLEPLAY_FEEDBACK_PREFIX = "Ah, I understand! But how about saying it like this?";
    var rolePlayState = {
      characterName: ROLEPLAY_CHARACTER_NAMES[Math.floor(Math.random() * ROLEPLAY_CHARACTER_NAMES.length)],
      turn: 1,
      turn1Done: false,
      studentTranscript: '',
      showFeedback: false,
      feedbackSuggestion: '',
      isListening: false,
      retryCount: 0,
      processedFromResult: false,
      lastTranscript: ''
    };

    function pickRandomRoleplay(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function normalizeRoleplay(s) { return (s || '').trim().toLowerCase().replace(/[.,!?\-']/g, ' ').replace(/\s+/g, ' ').trim(); }
    function checkRoleplayMatch(transcript) {
      var said = normalizeRoleplay(transcript);
      return ROLEPLAY_CHOICES.some(function (c) { return normalizeRoleplay(c) === said; });
    }
    function getRoleplayFemaleVoice() {
      var voices = speechSynthesis.getVoices();
      return voices.filter(function (v) { return /female|woman|samantha|karen|victoria|google/i.test(v.name) || (v.lang.indexOf('en') === 0 && v.name.length > 0); })[0] || null;
    }
    function speakRoleplayVoiceRSS(text, onEnd) {
      if (!VOICERSS_API_KEY) { onEnd(); return; }
      var url = 'https://api.voicerss.org/?key=' + encodeURIComponent(VOICERSS_API_KEY) + '&hl=en-us&v=Linda&c=MP3&src=' + encodeURIComponent(text);
      fetch(url).then(function (res) { return res.blob(); }).then(function (blob) {
        if (blob.size < 100 && blob.type === 'text/plain') { blob.text().then(function (t) { if (t.indexOf('ERROR') === 0) onEnd(); }); return; }
        var objectUrl = URL.createObjectURL(blob);
        var audio = new Audio(objectUrl);
        audio.onended = function () { URL.revokeObjectURL(objectUrl); onEnd(); };
        audio.onerror = function () { URL.revokeObjectURL(objectUrl); onEnd(); };
        audio.play().catch(function () { URL.revokeObjectURL(objectUrl); onEnd(); });
      }).catch(function () { onEnd(); });
    }
    function speakRoleplayBrowserTTS(text, onEnd) {
      if (!window.speechSynthesis) { onEnd(); return; }
      speechSynthesis.cancel();
      if (typeof speechSynthesis.resume === 'function') speechSynthesis.resume();
      var u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      u.rate = 0.95;
      u.pitch = 1;
      u.onend = onEnd;
      u.onerror = onEnd;
      var voices = speechSynthesis.getVoices();
      var voice = voices.length > 0 ? getRoleplayFemaleVoice() : null;
      if (voice) u.voice = voice;
      speechSynthesis.speak(u);
    }
    /* TTS: VOICERSS_API_KEY 있으면 VoiceRSS, 없으면 브라우저 Web Speech API */
    function speakRoleplayTTS(text, onEnd) {
      if (VOICERSS_API_KEY) speakRoleplayVoiceRSS(text, onEnd);
      else speakRoleplayBrowserTTS(text, onEnd);
    }

    function renderRolePlayScreen(state) {
      var turn = state.turn;
      var turn1Done = state.turn1Done;
      var progressFilled = 1;
      var charName = state.characterName;
      var studentTranscript = state.studentTranscript;
      var isListening = state.isListening;
      var showFeedback = state.showFeedback;
      var feedbackSuggestion = state.feedbackSuggestion;
      var retryCount = state.retryCount;
      var progressHtml = [1, 2, 3, 4, 5].map(function (i) {
        return '<div class="roleplay-progress-segment' + (i <= progressFilled ? ' roleplay-progress-segment--filled' : '') + '"></div>';
      }).join('');
      var turn1Html = '<div class="roleplay-bubble-row roleplay-bubble-row--character">' +
        '<img src="./ch.png" alt="" class="roleplay-avatar" aria-hidden="">' +
        '<div class="roleplay-bubble-wrap">' +
          '<span class="roleplay-name">' + charName + '</span>' +
          '<div class="roleplay-bubble roleplay-bubble--character">' + ROLEPLAY_TURN1_TEXT + '</div>' +
        '</div></div>';
      var turn2Html = '';
      if ((turn1Done && turn === 2) || turn === 3) {
        var studentBubbleContent = studentTranscript || (turn === 2 && isListening ? '...' : '\u00A0');
        var studentBubble = '<div class="roleplay-bubble roleplay-bubble--student">' + studentBubbleContent + '</div>';
        var choicesBlock = (turn === 2 && !studentTranscript) ? '<div class="roleplay-choices-wrap">' +
          '<span class="roleplay-choices-label">You can say:</span>' +
          '<div class="roleplay-choices">' + ROLEPLAY_CHOICES.map(function (c, i) { return '<button type="button" class="roleplay-choice roleplay-choice-btn" data-choice-index="' + i + '">' + c.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</button>'; }).join('') + '</div></div>' : '';
        var feedbackHtml = (turn === 2 && showFeedback) ? '<div class="roleplay-feedback">' + ROLEPLAY_FEEDBACK_PREFIX +
          '<div class="roleplay-feedback-suggestion">' + feedbackSuggestion + '</div>' +
          '<button type="button" class="roleplay-retry-btn" id="roleplay-retry-btn">' + (retryCount >= 2 ? 'Continue' : 'Try again') + '</button></div>' : '';
        turn2Html = '<div class="roleplay-bubble-row roleplay-bubble-row--student">' +
          '<img src="./selena.png" alt="" class="roleplay-avatar roleplay-avatar--student" aria-hidden="">' +
          '<div class="roleplay-bubble-wrap">' +
            '<span class="roleplay-name">' + ROLEPLAY_STUDENT_NAME + '</span>' +
            studentBubble +
            choicesBlock + feedbackHtml +
          '</div></div>';
      }
      var turn3Html = turn === 3 ? '<div class="roleplay-bubble-row roleplay-bubble-row--character">' +
        '<img src="./ch.png" alt="" class="roleplay-avatar" aria-hidden="">' +
        '<div class="roleplay-bubble-wrap">' +
          '<span class="roleplay-name">' + charName + '</span>' +
          '<div class="roleplay-bubble roleplay-bubble--character">' + ROLEPLAY_TURN3_TEXT + '</div>' +
        '</div></div>' : '';
      var micHtml = (turn === 2 && turn1Done) ? '<button type="button" class="mic-btn mic-btn--step3" id="btn-mic-roleplay" aria-label="Microphone" ' + (showFeedback || isListening ? ' disabled' : '') + '><svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button>' : '';
      var bottomHtml = (turn === 2 && turn1Done) ? '<div class="roleplay-bottom">' + micHtml + '</div>' : '';
      return '<div class="screen-content screen-content--step3-colors-no-frame">' +
        '<div class="roleplay-layout">' +
          '<div class="roleplay-top">' +
            '<div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div>' +
            '<div class="roleplay-progress-row" aria-label="Progress">' +
              '<div class="roleplay-progress">' + progressHtml + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="roleplay-chat">' + turn1Html + turn2Html + turn3Html + '</div>' +
          bottomHtml +
        '</div></div>';
    }

    function onRecognitionDone26(transcript) {
      if (rolePlayState.processedFromResult) return;
      rolePlayState.processedFromResult = true;
      rolePlayState.studentTranscript = transcript;
      if (checkRoleplayMatch(transcript)) {
        rolePlayState.turn = 3;
        rolePlayState.showFeedback = false;
        setTimeout(goNext, 1500);
      } else {
        rolePlayState.showFeedback = true;
        rolePlayState.feedbackSuggestion = pickRandomRoleplay(ROLEPLAY_CHOICES);
        rolePlayState.retryCount += 1;
      }
      mount();
    }

    function startRecognition26() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        rolePlayState.isListening = false;
        mount();
        return;
      }
      rolePlayState.processedFromResult = false;
      rolePlayState.lastTranscript = '';
      rolePlayState.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = true;
      rec.maxAlternatives = 1;
      rec.onresult = function (event) {
        var results = event.results;
        if (!results || results.length === 0) return;
        var needMount = false;
        for (var i = 0; i < results.length; i++) {
          var r = results[i];
          var alt = r.length ? (r[0] || r.item(0)) : null;
          var t = (alt && alt.transcript != null) ? String(alt.transcript).trim() : '';
          if (t) {
            rolePlayState.lastTranscript = t;
            rolePlayState.studentTranscript = t;
            needMount = true;
            if (r.isFinal && !rolePlayState.processedFromResult) {
              rolePlayState.processedFromResult = true;
              if (checkRoleplayMatch(t)) {
                rolePlayState.turn = 3;
                rolePlayState.showFeedback = false;
                setTimeout(goNext, 1500);
              } else {
                rolePlayState.showFeedback = true;
                rolePlayState.feedbackSuggestion = pickRandomRoleplay(ROLEPLAY_CHOICES);
                rolePlayState.retryCount += 1;
              }
              rolePlayState.isListening = false;
            }
          }
        }
        if (needMount) mount();
      };
      rec.onend = function () {
        rolePlayState.isListening = false;
        if (!rolePlayState.processedFromResult) onRecognitionDone26(rolePlayState.lastTranscript);
        else mount();
      };
      rec.onerror = function () {
        rolePlayState.isListening = false;
        if (!rolePlayState.processedFromResult) onRecognitionDone26(rolePlayState.lastTranscript);
        else mount();
      };
      try {
        rec.start();
      } catch (e) {
        rolePlayState.isListening = false;
        mount();
      }
    }

    function goNext() {
      if (screenIndex < 43) screenIndex++;
      mount();
    }

    function playPop() {
      try {
        var a = new Audio('./pop.mp3');
        a.play().catch(function () {});
      } catch (e) {}
    }

    function onRecognitionDone() {
      if (screen2State.checkmarkShown) return;
      screen2State.checkmarkShown = true;
      screen2State.recognitionDone = true;
      screen2State.showCheckmark = true;
      screen2State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen2State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone();
        return;
      }
      screen2State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone;
      rec.onend = function () {
        screen2State.isListening = false;
        if (!screen2State.checkmarkShown) onRecognitionDone();
        else mount();
      };
      rec.onerror = function () {
        screen2State.isListening = false;
        if (!screen2State.checkmarkShown) onRecognitionDone();
        else mount();
      };
      rec.start();
    }

    function onRecognitionDone4() {
      if (screen4State.checkmarkShown) return;
      screen4State.checkmarkShown = true;
      screen4State.recognitionDone = true;
      screen4State.showCheckmark = true;
      screen4State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen4State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition4() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone4();
        return;
      }
      screen4State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone4;
      rec.onend = function () {
        screen4State.isListening = false;
        if (!screen4State.checkmarkShown) onRecognitionDone4();
        else mount();
      };
      rec.onerror = function () {
        screen4State.isListening = false;
        if (!screen4State.checkmarkShown) onRecognitionDone4();
        else mount();
      };
      rec.start();
    }

    function onRecognitionDone6() {
      if (screen6State.checkmarkShown) return;
      screen6State.checkmarkShown = true;
      screen6State.recognitionDone = true;
      screen6State.showCheckmark = true;
      screen6State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen6State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition6() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone6();
        return;
      }
      screen6State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone6;
      rec.onend = function () {
        screen6State.isListening = false;
        if (!screen6State.checkmarkShown) onRecognitionDone6();
        else mount();
      };
      rec.onerror = function () {
        screen6State.isListening = false;
        if (!screen6State.checkmarkShown) onRecognitionDone6();
        else mount();
      };
      rec.start();
    }

    function onRecognitionDone9() {
      if (screen9State.checkmarkShown) return;
      screen9State.checkmarkShown = true;
      screen9State.recognitionDone = true;
      screen9State.showCheckmark = true;
      screen9State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen9State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition9() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone9();
        return;
      }
      screen9State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone9;
      rec.onend = function () {
        screen9State.isListening = false;
        if (!screen9State.checkmarkShown) onRecognitionDone9();
        else mount();
      };
      rec.onerror = function () {
        screen9State.isListening = false;
        if (!screen9State.checkmarkShown) onRecognitionDone9();
        else mount();
      };
      rec.start();
    }

    function onScreen9Tap() {
      if (screen9State.audioPlayed) return;
      screen9State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN9_AUDIO);
        a.playbackRate = 0.6;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }

    function normalizeForCompare(s) {
      return (s || '').trim().toLowerCase().replace(/[.,!?\-']/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function onRecognitionDone10(transcript) {
      if (typeof console !== 'undefined' && console.log) {
        console.log('[onRecognitionDone10] 호출됨 | screenIndex:', screenIndex, '| transcript:', JSON.stringify(transcript));
      }
      if (screen10State.checkmarkShown) return;
      screen10State.checkmarkShown = true;
      screen10State.recognitionDone = true;
      screen10State.isListening = false;

      if (screenIndex === 20) {
        var expected = normalizeForCompare(CENTER_TEXT_S10_LINE1);
        var said = normalizeForCompare(transcript);
        if (typeof console !== 'undefined' && console.log) {
          console.log('[STT 20] transcript:', JSON.stringify(transcript), '| said:', JSON.stringify(said), '| expected:', JSON.stringify(expected), '| match:', said === expected);
        }
        if (said === expected) {
          screen10State.showCheckmark = true;
          playDingDong();
          mount();
          setTimeout(function () {
            screen10State.showCheckmark = false;
            mount();
          }, 1200);
          setTimeout(goNext, 1500);
        } else {
          screen10State.showWrongMark = true;
          mount();
          var wrongAudio = new Audio(SCREEN10_AUDIO);
          wrongAudio.playbackRate = 1.0;
          wrongAudio.onended = function () {
            screen10State.showWrongMark = false;
            mount();
            goNext();
          };
          wrongAudio.play().catch(function () {
            screen10State.showWrongMark = false;
            mount();
            goNext();
          });
        }
        return;
      }

      screen10State.showCheckmark = true;
      playDingDong();
      mount();
      setTimeout(function () {
        screen10State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition10() {
      if (typeof console !== 'undefined' && console.log) console.log('[startRecognition10] 마이크 클릭 → STT 시작 (screenIndex 20용)');
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        console.warn('[startRecognition10] SpeechRecognition 없음');
        onRecognitionDone10('');
        return;
      }
      screen10State.isListening = true;
      mount();
      var lastTranscript10 = '';
      var processedFromResult10 = false;
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = function (event) {
        if (!event.results || !event.results.length) return;
        var last = event.results[event.results.length - 1];
        var alt = (last.length && (last[0] || (last.item && last.item(0)))) ? (last[0] || last.item(0)) : null;
        var t = (alt && (alt.transcript != null)) ? String(alt.transcript).trim() : '';
        if (t) lastTranscript10 = t;
        if (window.__sttDebug) { window.__sttDebug.lastTranscript = lastTranscript10; window.__sttDebug.lastScreenIndex = 20; window.__sttDebug.onResultCount = (window.__sttDebug.onResultCount || 0) + 1; }
        if (last.isFinal && t && !processedFromResult10) {
          processedFromResult10 = true;
          onRecognitionDone10(t);
        }
      };
      rec.onend = function () {
        screen10State.isListening = false;
        if (window.__sttDebug) { window.__sttDebug.onEndFired = true; window.__sttDebug.lastTranscript = lastTranscript10; window.__sttDebug.lastScreenIndex = 20; }
        if (!processedFromResult10 && !screen10State.checkmarkShown)
          onRecognitionDone10(lastTranscript10);
        else if (screen10State.checkmarkShown) mount();
      };
      rec.onerror = function () {
        screen10State.isListening = false;
        if (window.__sttDebug) { window.__sttDebug.lastTranscript = lastTranscript10; window.__sttDebug.lastScreenIndex = 20; }
        if (!processedFromResult10 && !screen10State.checkmarkShown)
          onRecognitionDone10(lastTranscript10);
        else if (screen10State.checkmarkShown) mount();
      };
      rec.start();
    }

    function onScreen11Tap() {
      if (screen11State.audioPlayed) return;
      screen11State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN11_AUDIO);
        a.playbackRate = 0.6;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }

    function onRecognitionDone11() {
      if (screen11State.checkmarkShown) return;
      screen11State.checkmarkShown = true;
      screen11State.recognitionDone = true;
      screen11State.showCheckmark = true;
      screen11State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen11State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition11() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone11();
        return;
      }
      screen11State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone11;
      rec.onend = function () {
        screen11State.isListening = false;
        if (!screen11State.checkmarkShown) onRecognitionDone11();
        else mount();
      };
      rec.onerror = function () {
        screen11State.isListening = false;
        if (!screen11State.checkmarkShown) onRecognitionDone11();
        else mount();
      };
      rec.start();
    }

    function onRecognitionDone12() {
      if (screen12State.checkmarkShown) return;
      screen12State.checkmarkShown = true;
      screen12State.recognitionDone = true;
      screen12State.showCheckmark = true;
      screen12State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen12State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition12() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone12();
        return;
      }
      screen12State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone12;
      rec.onend = function () {
        screen12State.isListening = false;
        if (!screen12State.checkmarkShown) onRecognitionDone12();
        else if (screenIndex === 21) mount();
      };
      rec.onerror = function () {
        screen12State.isListening = false;
        if (!screen12State.checkmarkShown) onRecognitionDone12();
        else if (screenIndex === 21) mount();
      };
      rec.start();
    }

    function onScreen13Tap() {
      if (screen13State.audioPlayed) return;
      screen13State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN13_AUDIO);
        a.playbackRate = 0.6;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }

    function onRecognitionDone13() {
      if (screen13State.checkmarkShown) return;
      screen13State.checkmarkShown = true;
      screen13State.recognitionDone = true;
      screen13State.showCheckmark = true;
      screen13State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen13State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition13() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone13();
        return;
      }
      screen13State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone13;
      rec.onend = function () {
        screen13State.isListening = false;
        if (!screen13State.checkmarkShown) onRecognitionDone13();
        else mount();
      };
      rec.onerror = function () {
        screen13State.isListening = false;
        if (!screen13State.checkmarkShown) onRecognitionDone13();
        else mount();
      };
      rec.start();
    }

    function onRecognitionDone14() {
      if (screen14State.checkmarkShown) return;
      screen14State.checkmarkShown = true;
      screen14State.recognitionDone = true;
      screen14State.showCheckmark = true;
      screen14State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen14State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition14() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone14();
        return;
      }
      screen14State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone14;
      rec.onend = function () {
        screen14State.isListening = false;
        if (!screen14State.checkmarkShown) onRecognitionDone14();
        else mount();
      };
      rec.onerror = function () {
        screen14State.isListening = false;
        if (!screen14State.checkmarkShown) onRecognitionDone14();
        else mount();
      };
      rec.start();
    }

    function onScreen15Tap() {
      if (screen15State.audioPlayed) return;
      screen15State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN15_AUDIO);
        a.playbackRate = 0.6;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }

    function onRecognitionDone15() {
      if (screen15State.checkmarkShown) return;
      screen15State.checkmarkShown = true;
      screen15State.recognitionDone = true;
      screen15State.showCheckmark = true;
      screen15State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen15State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition15() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone15();
        return;
      }
      screen15State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone15;
      rec.onend = function () {
        screen15State.isListening = false;
        if (!screen15State.checkmarkShown) onRecognitionDone15();
        else mount();
      };
      rec.onerror = function () {
        screen15State.isListening = false;
        if (!screen15State.checkmarkShown) onRecognitionDone15();
        else mount();
      };
      rec.start();
    }

    function onScreen16Tap() {
      if (screen16State.audioPlayed) return;
      screen16State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN16_AUDIO);
        a.playbackRate = 0.6;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }

    function onRecognitionDone16() {
      if (screen16State.checkmarkShown) return;
      screen16State.checkmarkShown = true;
      screen16State.recognitionDone = true;
      screen16State.showCheckmark = true;
      screen16State.isListening = false;
      playDingDong();
      if (screenIndex !== 14) return;
      mount();
      setTimeout(function () {
        if (screenIndex !== 14) return;
        screen16State.showCheckmark = false;
        screen16State.showSpeedUpPopup = true;
        playNotificationSound();
        requestAnimationFrame(function () {
          updateScreen16OverlayOnly(screen16State, 'Speed Up!');
        });
        setTimeout(function () {
          if (screenIndex === 14) goNext();
        }, 1500);
      }, 1200);
    }

    function startRecognition16() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone16();
        return;
      }
      screen16State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone16;
      rec.onend = function () {
        screen16State.isListening = false;
        if (!screen16State.checkmarkShown) onRecognitionDone16();
        else if (screenIndex !== 14) setTimeout(function () { mount(); }, 0);
      };
      rec.onerror = function () {
        screen16State.isListening = false;
        if (!screen16State.checkmarkShown) onRecognitionDone16();
        else if (screenIndex !== 14) setTimeout(function () { mount(); }, 0);
      };
      rec.start();
    }

    function onRecognitionDone17() {
      if (screen17State.checkmarkShown) return;
      screen17State.checkmarkShown = true;
      screen17State.recognitionDone = true;
      screen17State.showCheckmark = true;
      screen17State.isListening = false;
      playDingDong();
      mount();
      var isIndex24 = (screenIndex === 24);
      if (isIndex24) {
        setTimeout(function () {
          screen17State.showCheckmark = false;
          screen17State.showGoodStamp = true;
          mount();
          var overlayEl = document.getElementById('app-overlay');
          if (overlayEl) {
            overlayEl.innerHTML = getScreen7GoodStampHtml(true);
            var stampEl = overlayEl.querySelector('.screen7-stamp-popup');
            if (stampEl) stampEl.addEventListener('click', function onStampClick() {
              overlayEl.innerHTML = '';
              stampEl.removeEventListener('click', onStampClick);
              goNext();
            });
          }
          try {
            var fb4 = new Audio('./fb4.mp3');
            fb4.onended = function () { /* 효과음만 재생, 다음 화면은 스탬프 클릭 시에만 이동 */ };
            fb4.play().catch(function () {});
          } catch (e) {}
        }, 1200);
      } else {
        setTimeout(function () {
          screen17State.showCheckmark = false;
          mount();
        }, 1200);
        setTimeout(goNext, 1500);
      }
    }

    function startRecognition17() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone17();
        return;
      }
      screen17State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone17;
      rec.onend = function () {
        screen17State.isListening = false;
        if (!screen17State.checkmarkShown) onRecognitionDone17();
        else mount();
      };
      rec.onerror = function () {
        screen17State.isListening = false;
        if (!screen17State.checkmarkShown) onRecognitionDone17();
        else mount();
      };
      rec.start();
    }

    function onRecognitionDone18() {
      if (screen18State.checkmarkShown) return;
      screen18State.checkmarkShown = true;
      screen18State.recognitionDone = true;
      screen18State.showCheckmark = true;
      screen18State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () {
        screen18State.showCheckmark = false;
        mount();
      }, 1200);
      setTimeout(goNext, 1500);
    }

    function startRecognition18() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        onRecognitionDone18();
        return;
      }
      screen18State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone18;
      rec.onend = function () {
        screen18State.isListening = false;
        if (!screen18State.checkmarkShown) onRecognitionDone18();
        else mount();
      };
      rec.onerror = function () {
        screen18State.isListening = false;
        if (!screen18State.checkmarkShown) onRecognitionDone18();
        else mount();
      };
      rec.start();
    }

    function onScreen20Tap() {
      if (screen20State.audioPlayed) return;
      screen20State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN9_AUDIO);
        a.playbackRate = 1;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }
    function onRecognitionDone20(transcript) {
      if (typeof console !== 'undefined' && console.log) {
        console.log('[onRecognitionDone20] 호출됨 | screenIndex:', screenIndex, '| transcript:', JSON.stringify(transcript));
      }
      if (screen20State.checkmarkShown) return;
      screen20State.checkmarkShown = true;
      screen20State.recognitionDone = true;
      screen20State.isListening = false;

      if (screenIndex === 15) {
        var expected = normalizeForCompare(CENTER_TEXT_S9_LINE1);
        var said = normalizeForCompare(transcript);
        if (typeof console !== 'undefined' && console.log) {
          console.log('[STT 15] transcript:', JSON.stringify(transcript), '| said:', JSON.stringify(said), '| expected:', JSON.stringify(expected), '| match:', said === expected);
        }
        if (said === expected) {
          screen20State.showCheckmark = true;
          playDingDong();
          mount();
          setTimeout(function () { screen20State.showCheckmark = false; mount(); }, 1200);
          setTimeout(goNext, 1500);
        } else {
          screen20State.showWrongMark = true;
          mount();
          var wrongAudio = new Audio(SCREEN9_AUDIO);
          wrongAudio.playbackRate = 1.0;
          wrongAudio.onended = function () {
            screen20State.showWrongMark = false;
            mount();
            goNext();
          };
          wrongAudio.play().catch(function () {
            screen20State.showWrongMark = false;
            mount();
            goNext();
          });
        }
        return;
      }

      screen20State.showCheckmark = true;
      playDingDong();
      mount();
      setTimeout(function () { screen20State.showCheckmark = false; mount(); }, 1200);
      setTimeout(goNext, 1500);
    }
    function startRecognition20() {
      if (typeof console !== 'undefined' && console.log) console.log('[startRecognition20] 마이크 클릭 → STT 시작 (screenIndex 15용)');
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { console.warn('[startRecognition20] SpeechRecognition 없음'); onRecognitionDone20(''); return; }
      screen20State.isListening = true;
      mount();
      var lastTranscript20 = '';
      var processedFromResult20 = false;
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = function (event) {
        if (!event.results || !event.results.length) return;
        var last = event.results[event.results.length - 1];
        var alt = (last.length && (last[0] || (last.item && last.item(0)))) ? (last[0] || last.item(0)) : null;
        var t = (alt && (alt.transcript != null)) ? String(alt.transcript).trim() : '';
        if (t) lastTranscript20 = t;
        if (window.__sttDebug) { window.__sttDebug.lastTranscript = lastTranscript20; window.__sttDebug.lastScreenIndex = 15; window.__sttDebug.onResultCount = (window.__sttDebug.onResultCount || 0) + 1; }
        if (last.isFinal && t && !processedFromResult20) {
          processedFromResult20 = true;
          onRecognitionDone20(t);
        }
      };
      rec.onend = function () {
        screen20State.isListening = false;
        if (window.__sttDebug) { window.__sttDebug.onEndFired = true; window.__sttDebug.lastTranscript = lastTranscript20; window.__sttDebug.lastScreenIndex = 15; }
        if (!processedFromResult20 && !screen20State.checkmarkShown)
          onRecognitionDone20(lastTranscript20);
        else if (screen20State.checkmarkShown) mount();
      };
      rec.onerror = function () {
        screen20State.isListening = false;
        if (window.__sttDebug) { window.__sttDebug.lastTranscript = lastTranscript20; window.__sttDebug.lastScreenIndex = 15; }
        if (!processedFromResult20 && !screen20State.checkmarkShown)
          onRecognitionDone20(lastTranscript20);
        else if (screen20State.checkmarkShown) mount();
      };
      rec.start();
    }

    function onScreen21Tap() {
      if (screen21State.audioPlayed) return;
      screen21State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN11_AUDIO);
        a.playbackRate = 1;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }
    function onRecognitionDone21() {
      if (screen21State.checkmarkShown) return;
      screen21State.checkmarkShown = true;
      screen21State.recognitionDone = true;
      screen21State.showCheckmark = true;
      screen21State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () { screen21State.showCheckmark = false; mount(); }, 1200);
      setTimeout(goNext, 1500);
    }
    function startRecognition21() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { onRecognitionDone21(); return; }
      screen21State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone21;
      rec.onend = function () { screen21State.isListening = false; if (!screen21State.checkmarkShown) onRecognitionDone21(); else mount(); };
      rec.onerror = function () { screen21State.isListening = false; if (!screen21State.checkmarkShown) onRecognitionDone21(); else mount(); };
      rec.start();
    }

    function onScreen22Tap() {
      if (screen22State.audioPlayed) return;
      screen22State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN13_AUDIO);
        a.playbackRate = 1;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }
    function onRecognitionDone22() {
      if (screen22State.checkmarkShown) return;
      screen22State.checkmarkShown = true;
      screen22State.recognitionDone = true;
      screen22State.showCheckmark = true;
      screen22State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () { screen22State.showCheckmark = false; mount(); }, 1200);
      setTimeout(goNext, 1500);
    }
    function startRecognition22() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { onRecognitionDone22(); return; }
      screen22State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone22;
      rec.onend = function () { screen22State.isListening = false; if (!screen22State.checkmarkShown) onRecognitionDone22(); else mount(); };
      rec.onerror = function () { screen22State.isListening = false; if (!screen22State.checkmarkShown) onRecognitionDone22(); else mount(); };
      rec.start();
    }

    function onScreen23Tap() {
      if (screen23State.audioPlayed) return;
      screen23State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN15_AUDIO);
        a.playbackRate = 1;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }
    function onRecognitionDone23() {
      if (screen23State.checkmarkShown) return;
      screen23State.checkmarkShown = true;
      screen23State.recognitionDone = true;
      screen23State.showCheckmark = true;
      screen23State.isListening = false;
      playDingDong();
      mount();
      setTimeout(function () { screen23State.showCheckmark = false; mount(); }, 1200);
      setTimeout(goNext, 1500);
    }
    function startRecognition23() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { onRecognitionDone23(); return; }
      screen23State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone23;
      rec.onend = function () { screen23State.isListening = false; if (!screen23State.checkmarkShown) onRecognitionDone23(); else mount(); };
      rec.onerror = function () { screen23State.isListening = false; if (!screen23State.checkmarkShown) onRecognitionDone23(); else mount(); };
      rec.start();
    }

    function onScreen24Tap() {
      if (screen24State.audioPlayed) return;
      screen24State.audioPlayed = true;
      try {
        var a = new Audio(SCREEN16_AUDIO);
        a.playbackRate = 1;
        a.play().catch(function () {});
      } catch (e) {}
      mount();
    }
    function onRecognitionDone24() {
      if (screen24State.checkmarkShown) return;
      screen24State.checkmarkShown = true;
      screen24State.recognitionDone = true;
      screen24State.showCheckmark = true;
      screen24State.isListening = false;
      playDingDong();
      setTimeout(function () { mount(); }, 0);
      setTimeout(function () {
        screen24State.showCheckmark = false;
        screen24State.showSpeedUpPopup = true;
        playNotificationSound();
        updateScreen16OverlayOnly(screen24State, 'Your turn!');
        setTimeout(goNext, 1500);
      }, 1200);
    }
    function startRecognition24() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { onRecognitionDone24(); return; }
      screen24State.isListening = true;
      mount();
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onresult = onRecognitionDone24;
      rec.onend = function () { screen24State.isListening = false; if (!screen24State.checkmarkShown) onRecognitionDone24(); else setTimeout(function () { mount(); }, 0); };
      rec.onerror = function () { screen24State.isListening = false; if (!screen24State.checkmarkShown) onRecognitionDone24(); else setTimeout(function () { mount(); }, 0); };
      rec.start();
    }

    function startRecognition37() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { screenIndex = 38; mount(); return; }
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      var didGo = false;
      var goTo38 = function () {
        if (didGo) return;
        didGo = true;
        playDingDong();
        screenIndex = 38;
        mount();
      };
      rec.onresult = goTo38;
      rec.onend = goTo38;
      rec.onerror = function () { playDingDong(); goTo38(); };
      try { rec.start(); } catch (e) { goTo38(); }
    }

    function startRecognition39(onDone) {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { playDingDong(); onDone(); return; }
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      var didDone = false;
      var finish = function () {
        if (didDone) return;
        didDone = true;
        playDingDong();
        onDone();
      };
      rec.onresult = finish;
      rec.onend = finish;
      rec.onerror = function () { playDingDong(); finish(); };
      try { rec.start(); } catch (e) { finish(); }
    }

    /* 인덱스 40 전용: 음성인식 끝나면 onDone만 호출 (딩동은 별 팝업 시에만). React 흐름과 동일 */
    function startRecognition40(onDone) {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { onDone(); return; }
      var rec = new SR();
      rec.continuous = false;
      rec.lang = 'en-US';
      rec.interimResults = false;
      var didDone = false;
      var finish = function () {
        if (didDone) return;
        didDone = true;
        onDone();
      };
      rec.onresult = finish;
      rec.onend = finish;
      rec.onerror = finish;
      try { rec.start(); } catch (e) { finish(); }
    }

    function renderScreen9(state, fastActive) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var showWrongMark = state.showWrongMark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var wrongMarkHtml = showWrongMark
        ? '<div class="wrong-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>' +
          '</div>'
        : '';
      var gradLine1 = (isListening || recognitionDone) ? ' main-text--gradient' : '';
      var speedCls = fastActive ? ' speed-display--fast-active' : '';
      var fastCls = fastActive ? ' speed-display-item--fast' : '';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="speed-display' + speedCls + '">' +
              '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
              '<span class="speed-display-sep" aria-hidden>/</span>' +
              '<span class="speed-display-item' + fastCls + '">Fast</span>' +
            '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<p class="main-text main-text--two-lines' + gradLine1 + '">' + CENTER_TEXT_S9_LINE1 + '</p>' +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S9_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
          wrongMarkHtml +
        '</div>'
      );
    }

    function renderScreen10(state, hideSpeedDisplay) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var showWrongMark = state.showWrongMark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var wrongMarkHtml = showWrongMark
        ? '<div class="wrong-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>' +
          '</div>'
        : '';
      var englishHtml = (isListening || recognitionDone)
        ? '<p class="main-text main-text--two-lines main-text--gradient">' + CENTER_TEXT_S10_LINE1 + '</p>'
        : '';
      var speedDisplayHtml = hideSpeedDisplay ? '' : '<div class="speed-display">' +
        '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
        '<span class="speed-display-sep" aria-hidden>/</span>' +
        '<span class="speed-display-item">Fast</span></div>';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            speedDisplayHtml +
            '<div class="screen-main screen-main--vertical-center">' +
              englishHtml +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S10_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
          wrongMarkHtml +
        '</div>'
      );
    }

    // Index 12 – Type 2-1: audio on tap, English + Korean both visible, mic → gradient on English
    function renderScreen11(state, fastActive) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var gradLine1 = (isListening || recognitionDone) ? ' main-text--gradient' : '';
      var speedCls = fastActive ? ' speed-display--fast-active' : '';
      var fastCls = fastActive ? ' speed-display-item--fast' : '';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="speed-display' + speedCls + '">' +
              '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
              '<span class="speed-display-sep" aria-hidden>/</span>' +
              '<span class="speed-display-item' + fastCls + '">Fast</span>' +
            '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              '<p class="main-text main-text--two-lines' + gradLine1 + '">' + CENTER_TEXT_S11_LINE1 + '</p>' +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S11_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    function renderScreen12(state, hideSpeedDisplay) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var englishHtml = (isListening || recognitionDone)
        ? '<p class="main-text main-text--two-lines main-text--gradient">' + CENTER_TEXT_S12_LINE1 + '</p>'
        : '';
      var speedDisplayHtml = hideSpeedDisplay ? '' : '<div class="speed-display">' +
        '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
        '<span class="speed-display-sep" aria-hidden>/</span>' +
        '<span class="speed-display-item">Fast</span></div>';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            speedDisplayHtml +
            '<div class="screen-main screen-main--vertical-center">' +
              englishHtml +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S12_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    function renderScreen13(state, fastActive) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var showFill = isListening || recognitionDone;
      var line1Html = showFill
        ? '<p class="main-text main-text--two-lines">' +
            '<span class="main-text--gradient-sequential">' + CENTER_TEXT_S13_LINE1_PREFIX + CENTER_TEXT_S13_FILL + '.</span>' +
          '</p>'
        : '<p class="main-text main-text--two-lines">' + CENTER_TEXT_S13_LINE1_PREFIX + '<span class="main-text-blank-box"><span class="main-text-blank-box__hint">' + CENTER_TEXT_S13_FILL + '</span></span>.</p>';
      var speedCls = fastActive ? ' speed-display--fast-active' : '';
      var fastCls = fastActive ? ' speed-display-item--fast' : '';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="speed-display' + speedCls + '">' +
              '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
              '<span class="speed-display-sep" aria-hidden>/</span>' +
              '<span class="speed-display-item' + fastCls + '">Fast</span>' +
            '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              line1Html +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S13_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    function renderScreen14(state, hideSpeedDisplay) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var showFill = isListening || recognitionDone;
      var englishHtml = showFill
        ? '<p class="main-text main-text--two-lines">' +
            '<span class="main-text--gradient-sequential">' + CENTER_TEXT_S13_LINE1_PREFIX + CENTER_TEXT_S13_FILL + '.</span>' +
          '</p>'
        : '';
      var speedDisplayHtml = hideSpeedDisplay ? '' : '<div class="speed-display">' +
        '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
        '<span class="speed-display-sep" aria-hidden>/</span>' +
        '<span class="speed-display-item">Fast</span></div>';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            speedDisplayHtml +
            '<div class="screen-main screen-main--vertical-center">' +
              englishHtml +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S13_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    function renderScreen15(state, fastActive) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var showFill = isListening || recognitionDone;
      var line1Html = showFill
        ? '<p class="main-text main-text--two-lines">' +
            '<span class="main-text--gradient-sequential">' + CENTER_TEXT_S15_LINE1_PREFIX + CENTER_TEXT_S15_FILL + '.</span>' +
          '</p>'
        : '<p class="main-text main-text--two-lines">' + CENTER_TEXT_S15_LINE1_PREFIX + '<span class="main-text-blank-box"><span class="main-text-blank-box__hint">' + CENTER_TEXT_S15_FILL + '</span></span>.</p>';
      var speedCls = fastActive ? ' speed-display--fast-active' : '';
      var fastCls = fastActive ? ' speed-display-item--fast' : '';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="speed-display' + speedCls + '">' +
              '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
              '<span class="speed-display-sep" aria-hidden>/</span>' +
              '<span class="speed-display-item' + fastCls + '">Fast</span>' +
            '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              line1Html +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S15_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    function renderScreen16(state, fastActive, popupText) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var showSpeedUpPopup = state.showSpeedUpPopup;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = '';
      var speedUpPopupHtml = '';
      var showFill = isListening || recognitionDone;
      var line1Html = showFill
        ? '<p class="main-text main-text--two-lines">' +
            '<span class="main-text--gradient-sequential">' + CENTER_TEXT_S16_LINE1_PREFIX + CENTER_TEXT_S16_FILL + '.</span>' +
          '</p>'
        : '<p class="main-text main-text--two-lines">' + CENTER_TEXT_S16_LINE1_PREFIX + '<span class="main-text-blank-box"><span class="main-text-blank-box__hint">' + CENTER_TEXT_S16_FILL + '</span></span>.</p>';
      var speedCls = fastActive ? ' speed-display--fast-active' : '';
      var fastCls = fastActive ? ' speed-display-item--fast' : '';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            '<div class="speed-display' + speedCls + '">' +
              '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
              '<span class="speed-display-sep" aria-hidden>/</span>' +
              '<span class="speed-display-item' + fastCls + '">Fast</span>' +
            '</div>' +
            '<div class="screen-main screen-main--vertical-center">' +
              line1Html +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S16_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
          speedUpPopupHtml +
        '</div>'
      );
    }

    function getScreen16OverlayHtml(state, popupText) {
      if (state.showCheckmark) {
        return '<div class="checkmark-popup" role="status">' +
          '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>';
      }
      if (state.showSpeedUpPopup) {
        return '<div class="speed-up-popup" role="status">' + (popupText !== undefined ? popupText : 'Speed Up!') + '</div>';
      }
      return '';
    }

    function getGoodStampOverlayHtml() {
      return '<div class="screen7-stamp-popup" role="status" aria-label="Good">' +
        '<div class="screen7-stamp-circle">' +
          '<svg class="screen7-stamp-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><path id="stamp-good-star" d="M0 -2.1 L0.5 -0.5 L2.2 -0.5 L0.8 0.5 L1.3 2.1 L0 1.1 L-1.3 2.1 L-0.8 0.5 L-2.2 -0.5 L-0.5 -0.5 Z" fill="#fff"/></defs>' +
            '<circle cx="60" cy="60" r="52" fill="none" stroke="#fff" stroke-width="3"/>' +
            '<use href="#stamp-good-star" transform="translate(98, 38) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(82, 22) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(60, 16) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(38, 22) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(22, 38) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(22, 82) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(38, 98) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(60, 104) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(82, 98) scale(2)"/>' +
            '<use href="#stamp-good-star" transform="translate(98, 82) scale(2)"/>' +
            '<text x="60" y="62" text-anchor="middle" dominant-baseline="central" class="screen7-stamp-text" fill="#fff">GOOD!</text>' +
          '</svg>' +
        '</div>' +
      '</div>';
    }

    function updateScreen16OverlayOnly(state, popupText) {
      var overlayEl = document.getElementById('app-overlay');
      if (!overlayEl) {
        overlayEl = document.createElement('div');
        overlayEl.id = 'app-overlay';
        overlayEl.className = 'app-overlay';
        document.body.appendChild(overlayEl);
      }
      overlayEl.innerHTML = getScreen16OverlayHtml(state, popupText);
      var speedUpPopup = overlayEl.querySelector('.speed-up-popup');
      if (speedUpPopup) speedUpPopup.addEventListener('click', function (e) { e.stopPropagation(); goNext(); });
    }

    function getScreen7GoodStampHtml(overlay) {
      var cls = 'screen7-stamp-popup' + (overlay ? ' screen7-stamp-popup--overlay' : '');
      return '<div class="' + cls + '" role="button" tabindex="0" aria-label="다음으로">' +
        '<div class="screen7-stamp-circle">' +
          '<svg class="screen7-stamp-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><path id="stamp-small-star-17" d="M0 -2.1 L0.5 -0.5 L2.2 -0.5 L0.8 0.5 L1.3 2.1 L0 1.1 L-1.3 2.1 L-0.8 0.5 L-2.2 -0.5 L-0.5 -0.5 Z" fill="#fff"/></defs>' +
            '<circle cx="60" cy="60" r="52" fill="none" stroke="#fff" stroke-width="3"/>' +
            '<use href="#stamp-small-star-17" transform="translate(98, 38) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(82, 22) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(60, 16) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(38, 22) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(22, 38) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(22, 82) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(38, 98) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(60, 104) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(82, 98) scale(2)"/>' +
            '<use href="#stamp-small-star-17" transform="translate(98, 82) scale(2)"/>' +
            '<text x="60" y="62" text-anchor="middle" dominant-baseline="central" class="screen7-stamp-text" fill="#fff">GOOD!</text>' +
          '</svg>' +
        '</div>' +
      '</div>';
    }
    function renderScreen17(state, hideSpeedDisplay, useGoodStampOverlay) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var showGoodStamp = state.showGoodStamp;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var goodStampHtml = showGoodStamp ? getScreen7GoodStampHtml(!!useGoodStampOverlay) : '';
      var showFill = isListening || recognitionDone;
      var englishHtml = showFill
        ? '<p class="main-text main-text--two-lines">' +
            '<span class="main-text--gradient-sequential">' + CENTER_TEXT_S17_LINE1_PREFIX + CENTER_TEXT_S17_FILL + '.</span>' +
          '</p>'
        : '';
      var speedDisplayHtml = hideSpeedDisplay ? '' : '<div class="speed-display">' +
        '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
        '<span class="speed-display-sep" aria-hidden>/</span>' +
        '<span class="speed-display-item">Fast</span></div>';
      return (
        '<div class="screen-content">' +
          goodStampHtml +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            speedDisplayHtml +
            '<div class="screen-main screen-main--vertical-center">' +
              englishHtml +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S17_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    // Index 15 – Type 2-4: 나는 피터예요. (English hidden) → mic → I am Peter.
    function renderScreen18(state, hideSpeedDisplay) {
      var recognitionDone = state.recognitionDone;
      var showCheckmark = state.showCheckmark;
      var isListening = state.isListening;
      var micHtml = '<button type="button" class="mic-btn" id="btn-mic" aria-label="Microphone"' +
        (isListening || recognitionDone ? ' disabled' : '') + '>' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>' +
        '</button>';
      var checkmarkHtml = showCheckmark
        ? '<div class="checkmark-popup" role="status">' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</div>'
        : '';
      var showFill = isListening || recognitionDone;
      var englishHtml = showFill
        ? '<p class="main-text main-text--two-lines">' +
            '<span class="main-text--gradient-sequential">' + CENTER_TEXT_S18_LINE1_PREFIX + CENTER_TEXT_S18_FILL + '.</span>' +
          '</p>'
        : '';
      var speedDisplayHtml = hideSpeedDisplay ? '' : '<div class="speed-display">' +
        '<span class="speed-display-item speed-display-item--slow">Slow</span>' +
        '<span class="speed-display-sep" aria-hidden>/</span>' +
        '<span class="speed-display-item">Fast</span></div>';
      return (
        '<div class="screen-content">' +
          '<div class="screen-center">' +
            '<div class="topic-box">' + TOPIC_TEXT + '</div>' +
            speedDisplayHtml +
            '<div class="screen-main screen-main--vertical-center">' +
              englishHtml +
              '<p class="main-text main-text--two-lines main-text--sub">' + CENTER_TEXT_S18_LINE2 + '</p>' +
            '</div>' +
            '<div class="screen-bottom">' + micHtml + '</div>' +
          '</div>' +
          checkmarkHtml +
        '</div>'
      );
    }

    function mount() {
      var el = document.getElementById('app-content');
      if (!el) return;
      var header = document.getElementById('app-header');
      var overlayEl = document.getElementById('app-overlay');
      var appEl = document.querySelector('.app');
      document.body.style.background = '';
      document.documentElement.style.background = '';
      if (header) header.className = 'app-header';
      if (appEl) {
        appEl.classList.remove('app--step3-colors');
        appEl.style.background = '';
        appEl.style.border = '';
        appEl.style.boxShadow = '';
      }
      if (overlayEl && screenIndex !== 14 && screenIndex !== 19) overlayEl.innerHTML = '';

      if (screenIndex === 0) {
        if (header) header.style.display = 'none';
        el.innerHTML = renderCornerSelect();
        var btnStep1 = document.getElementById('btn-step1');
        if (btnStep1) btnStep1.onclick = function () { screenIndex = 1; mount(); };
        var btnStep2 = document.getElementById('btn-step2');
        if (btnStep2) btnStep2.onclick = function () { screenIndex = 9; mount(); };
        var btnStep3 = document.getElementById('btn-step3');
        if (btnStep3) btnStep3.onclick = function () { screenIndex = 25; mount(); };
        var btnRealTalk2 = document.getElementById('btn-realtalk2');
        if (btnRealTalk2) btnRealTalk2.onclick = function () { screenIndex = 36; mount(); };
        return;
      }

      if (screenIndex === 1) {
        if (header) header.style.display = 'none';
        el.innerHTML = renderCornerIntro('STEP 1', CORNER_TITLE);
        el.querySelector('.corner-intro-screen').addEventListener('click', goNext);
        return;
      }

      if (screenIndex === 9) {
        if (header) header.style.display = 'none';
        el.innerHTML = renderCornerIntro(CORNER_STEP_2, CORNER_TITLE_2);
        el.querySelector('.corner-intro-screen').addEventListener('click', goNext);
        return;
      }

      if (header) header.style.display = '';

      if (screenIndex === 2) {
        el.innerHTML = renderScreen1(screen1State);
        el.querySelector('.screen-content').addEventListener('click', onScreen1Tap);
        return;
      }

      if (screenIndex === 4) {
        el.innerHTML = renderScreen3(screen3State);
        el.querySelector('.screen-content').addEventListener('click', onScreen3Tap);
        return;
      }

      if (screenIndex === 5) {
        el.innerHTML = renderScreen4(screen4State, goNext);
        playPop();
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = startRecognition4;
        return;
      }

      if (screenIndex === 6) {
        el.innerHTML = renderScreen5(screen5State);
        el.querySelector('.screen-content').addEventListener('click', onScreen5Tap);
        return;
      }

      if (screenIndex === 7) {
        el.innerHTML = renderScreen6(screen6State, goNext);
        playPop();
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = startRecognition6;
        return;
      }

      if (screenIndex === 8) {
        el.innerHTML = renderScreen7(screen7State);
        el.querySelector('.screen-content').addEventListener('click', onScreen7Tap);
        var stampPopup = el.querySelector('.screen7-stamp-popup');
        if (stampPopup) stampPopup.onclick = function (e) { e.stopPropagation(); goNext(); };
        return;
      }

      if (screenIndex === 10) {
        el.innerHTML = renderScreen9(screen9State);
        el.querySelector('.screen-content').addEventListener('click', onScreen9Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition9(); };
        return;
      }

      if (screenIndex === 11) {
        el.innerHTML = renderScreen11(screen11State);
        el.querySelector('.screen-content').addEventListener('click', onScreen11Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition11(); };
        return;
      }

      if (screenIndex === 12) {
        el.innerHTML = renderScreen13(screen13State);
        el.querySelector('.screen-content').addEventListener('click', onScreen13Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition13(); };
        return;
      }

      if (screenIndex === 13) {
        el.innerHTML = renderScreen15(screen15State);
        el.querySelector('.screen-content').addEventListener('click', onScreen15Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition15(); };
        return;
      }

      if (screenIndex === 14) {
        el.innerHTML = renderScreen16(screen16State);
        var screenContent = el.querySelector('.screen-content');
        if (screenContent) screenContent.addEventListener('click', onScreen16Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition16(); };
        if (overlayEl) {
          overlayEl.innerHTML = getScreen16OverlayHtml(screen16State, 'Speed Up!');
          var speedUpPopup = overlayEl.querySelector('.speed-up-popup');
          if (speedUpPopup) speedUpPopup.addEventListener('click', function (e) { e.stopPropagation(); goNext(); });
        }
        return;
      }

      if (screenIndex === 15) {
        el.innerHTML = renderScreen9(screen20State, true);
        el.querySelector('.screen-content').addEventListener('click', onScreen20Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition20(); };
        var d = window.__sttDebug || {};
        var debugBar = document.createElement('div');
        debugBar.className = 'stt-debug-bar';
        debugBar.setAttribute('aria-hidden', 'true');
        debugBar.textContent = 'STT: ' + d.api + ' | screenIndex: 15 | 마지막 인식: "' + (d.lastTranscript || '') + '" | onResult 횟수: ' + (d.onResultCount || 0);
        el.appendChild(debugBar);
        return;
      }

      if (screenIndex === 16) {
        el.innerHTML = renderScreen11(screen21State, true);
        el.querySelector('.screen-content').addEventListener('click', onScreen21Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition21(); };
        return;
      }

      if (screenIndex === 17) {
        el.innerHTML = renderScreen13(screen22State, true);
        el.querySelector('.screen-content').addEventListener('click', onScreen22Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition22(); };
        return;
      }

      if (screenIndex === 18) {
        el.innerHTML = renderScreen15(screen23State, true);
        el.querySelector('.screen-content').addEventListener('click', onScreen23Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition23(); };
        return;
      }

      if (screenIndex === 19) {
        el.innerHTML = renderScreen16(screen24State, true, 'Your turn!');
        el.querySelector('.screen-content').addEventListener('click', onScreen24Tap);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition24(); };
        if (overlayEl) {
          overlayEl.innerHTML = getScreen16OverlayHtml(screen24State, 'Your turn!');
          var speedUpPopup = overlayEl.querySelector('.speed-up-popup');
          if (speedUpPopup) speedUpPopup.addEventListener('click', function (e) { e.stopPropagation(); goNext(); });
        }
        return;
      }

      if (screenIndex === 20) {
        el.innerHTML = renderScreen10(screen10State, true);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition10(); };
        var d = window.__sttDebug || {};
        var debugBar = document.createElement('div');
        debugBar.className = 'stt-debug-bar';
        debugBar.setAttribute('aria-hidden', 'true');
        debugBar.textContent = 'STT: ' + d.api + ' | screenIndex: 20 | 마지막 인식: "' + (d.lastTranscript || '') + '" | onResult 횟수: ' + (d.onResultCount || 0);
        el.appendChild(debugBar);
        return;
      }

      if (screenIndex === 21) {
        el.innerHTML = renderScreen12(screen12State, true);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition12(); };
        return;
      }

      if (screenIndex === 22) {
        var html22 = renderScreen18(screen18State, true);
        el.innerHTML = html22;
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition18(); };
        setTimeout(function () {
          if (screenIndex !== 22) return;
          var el22 = document.getElementById('app-content');
          if (el22) { el22.innerHTML = html22; var m = document.getElementById('btn-mic'); if (m) m.onclick = function (e) { e.stopPropagation(); startRecognition18(); }; }
        }, 0);
        return;
      }

      if (screenIndex === 23) {
        el.innerHTML = renderScreen14(screen14State, true);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition14(); };
        return;
      }

      if (screenIndex === 24) {
        el.innerHTML = renderScreen17(screen17State, true, true);
        var btnMic = document.getElementById('btn-mic');
        if (btnMic) btnMic.onclick = function (e) { e.stopPropagation(); startRecognition17(); };
        var stampPopup = el.querySelector('.screen7-stamp-popup');
        if (stampPopup) stampPopup.onclick = function (e) { e.stopPropagation(); goNext(); };
        return;
      }

      if (screenIndex === 25) {
        if (header) header.style.display = 'none';
        el.innerHTML = renderCornerIntro(CORNER_STEP_3, CORNER_TITLE_3, true);
        el.querySelector('.corner-intro-screen').addEventListener('click', goNext);
        return;
      }

      if (screenIndex === 26) {
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) {
          appEl.style.background = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
          appEl.style.border = '';
          appEl.style.boxShadow = 'none';
        }
        if (overlayEl) overlayEl.innerHTML = '';
        el.innerHTML = renderRolePlayScreen(rolePlayState);
        var btnMicRoleplay = document.getElementById('btn-mic-roleplay');
        if (btnMicRoleplay) btnMicRoleplay.onclick = function (e) { e.stopPropagation(); startRecognition26(); };
        var retryBtn = document.getElementById('roleplay-retry-btn');
        function onRetryOrContinue() {
          if (rolePlayState.retryCount >= 2) {
            rolePlayState.turn = 3;
            rolePlayState.showFeedback = false;
            setTimeout(goNext, 1500);
            mount();
            return;
          }
          rolePlayState.showFeedback = false;
          rolePlayState.processedFromResult = false;
          rolePlayState.isListening = false;
          mount();
        }
        if (retryBtn) retryBtn.onclick = function (e) { e.stopPropagation(); onRetryOrContinue(); };
        var choiceBtns = el.querySelectorAll('.roleplay-choice-btn');
        for (var j = 0; j < choiceBtns.length; j++) {
          choiceBtns[j].onclick = function (e) {
            e.stopPropagation();
            var idx = parseInt(this.getAttribute('data-choice-index'), 10);
            if (!isNaN(idx) && ROLEPLAY_CHOICES[idx]) onRecognitionDone26(ROLEPLAY_CHOICES[idx]);
          };
        }
        if (rolePlayState.turn === 1) {
          setTimeout(function () {
            if (rolePlayState.turn !== 1) return;
            rolePlayState.turn1Done = true;
            rolePlayState.turn = 2;
            mount();
          }, 800);
        }
        return;
      }

      if (screenIndex === 36) {
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) {
          appEl.style.background = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
          appEl.style.border = '';
          appEl.style.boxShadow = 'none';
        }
        if (overlayEl) overlayEl.innerHTML = '';
        var realtalkHtml36 = '<div class="screen-content screen-content--step3-colors-no-frame">' +
          '<div class="realtalk-layout">' +
            '<div class="realtalk-top"><div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div></div>' +
            '<div class="realtalk-main">' +
              '<img src="./girl.png" alt="" class="realtalk-main-image">' +
            '</div>' +
            '<div class="realtalk-bottom"><button type="button" class="realtalk-go-btn realtalk-go-btn--hidden" id="realtalk-go-36">GO!</button></div>' +
          '</div></div>';
        el.innerHTML = realtalkHtml36;
        var goBtn36 = document.getElementById('realtalk-go-36');
        if (goBtn36) goBtn36.onclick = function () { screenIndex = 37; mount(); };
        try {
          var audio36 = new Audio('./realtalk0.mp3');
          audio36.addEventListener('ended', function () {
            var btn = document.getElementById('realtalk-go-36');
            if (btn) btn.classList.remove('realtalk-go-btn--hidden');
          });
          audio36.play().catch(function () {
            var btn = document.getElementById('realtalk-go-36');
            if (btn) btn.classList.remove('realtalk-go-btn--hidden');
          });
        } catch (e) {
          var btn = document.getElementById('realtalk-go-36');
          if (btn) btn.classList.remove('realtalk-go-btn--hidden');
        }
        return;
      }

      if (screenIndex === 37) {
        var step3Bg = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
        document.body.style.background = step3Bg;
        document.documentElement.style.background = step3Bg;
        document.body.style.backgroundAttachment = 'fixed';
        document.documentElement.style.backgroundAttachment = 'fixed';
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) {
          appEl.style.background = step3Bg;
          appEl.style.border = '';
          appEl.style.boxShadow = 'none';
        }
        if (overlayEl) overlayEl.innerHTML = '';
        var mic37Svg = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>';
        var realtalkHtml37 = '<div class="screen-content screen-content--step3-colors-no-frame">' +
          '<div class="realtalk2-layout realtalk-layout realtalk-layout--reserve-go-space realtalk-layout--with-text-slots">' +
            '<div class="realtalk-top"><div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div></div>' +
            '<div class="realtalk2-text-above realtalk2-slot-two-lines" aria-hidden="true"><span class="realtalk2-text-placeholder"></span></div>' +
            '<div class="realtalk-main">' +
              '<img src="./girl1.png" alt="" class="realtalk-main-image">' +
            '</div>' +
            '<div class="realtalk2-text-below realtalk2-slot-two-lines" aria-hidden="true"><span class="realtalk2-text-placeholder"></span></div>' +
            '<div class="realtalk-bottom realtalk2-bottom--fixed-height">' +
              '<button type="button" class="mic-btn mic-btn--step3 realtalk-mic37--hidden" id="btn-mic-37" aria-label="Microphone">' + mic37Svg + '</button>' +
            '</div>' +
          '</div></div>';
        el.innerHTML = realtalkHtml37;
        try {
          var audio37 = new Audio('./realtalk1.mp3');
          audio37.addEventListener('ended', function () {
            var btn = document.getElementById('btn-mic-37');
            if (btn) { btn.classList.remove('realtalk-mic37--hidden'); btn.onclick = function (e) { e.stopPropagation(); startRecognition37(); }; }
          });
          audio37.play().catch(function () {});
        } catch (e) {}
        return;
      }

      if (screenIndex === 38) {
        var step3Bg38 = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
        document.body.style.background = step3Bg38;
        document.documentElement.style.background = step3Bg38;
        document.body.style.backgroundAttachment = 'fixed';
        document.documentElement.style.backgroundAttachment = 'fixed';
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) { appEl.style.background = step3Bg38; appEl.style.border = ''; appEl.style.boxShadow = 'none'; }
        if (overlayEl) overlayEl.innerHTML = '';
        var mic38Svg = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>';
        var realtalkHtml38 = '<div class="screen-content screen-content--step3-colors-no-frame">' +
          '<div class="realtalk2-layout realtalk-layout--reserve-go-space realtalk-layout--with-text-slots">' +
            '<div class="realtalk-top"><div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div></div>' +
            '<div class="realtalk2-text-above realtalk2-slot-two-lines" aria-hidden="true"><span class="realtalk2-text-placeholder"></span></div>' +
            '<div class="realtalk-main"><img src="./girl1.png" alt="" class="realtalk-main-image"></div>' +
            '<div class="realtalk2-text-below realtalk2-slot-two-lines" aria-hidden="true"><span class="realtalk2-text-placeholder"></span></div>' +
            '<div class="realtalk-bottom realtalk2-bottom--fixed-height">' +
              '<button type="button" class="mic-btn mic-btn--step3' + (turn38ShowMic ? '' : ' realtalk2-mic--hidden') + '" id="btn-mic-38" aria-label="Microphone">' + mic38Svg + '</button>' +
            '</div></div></div>';
        el.innerHTML = realtalkHtml38;
        var playIntro38 = function () {
          var a = new Audio('./realtalk1.mp3');
          a.onended = a.onerror = function () { turn38ShowMic = true; mount(); };
          a.play().catch(function () { turn38ShowMic = true; mount(); });
        };
        if (!turn38ShowMic) playIntro38();
        var btn38 = document.getElementById('btn-mic-38');
        if (btn38 && turn38ShowMic) btn38.onclick = function (e) {
          e.stopPropagation();
          var audio38 = new Audio('./real3.mp3');
          var go39 = function () { screenIndex = 39; mount(); };
          var t38 = setTimeout(go39, 20000);
          audio38.onended = function () { clearTimeout(t38); go39(); };
          audio38.onerror = function () { clearTimeout(t38); go39(); };
          audio38.play().catch(function () { clearTimeout(t38); go39(); });
        };
        return;
      }

      if (screenIndex === 39) {
        var step3Bg39 = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
        document.body.style.background = step3Bg39;
        document.documentElement.style.background = step3Bg39;
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) { appEl.style.background = step3Bg39; appEl.style.border = ''; appEl.style.boxShadow = 'none'; }
        if (overlayEl) overlayEl.innerHTML = '';
        var mic39Svg = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>';
        var textAbove39 = turn39ShowModelText
          ? '<div class="realtalk2-text-above realtalk2-slot-two-lines realtalk2-text-above--has-content" aria-hidden="false"><p class="realtalk2-model-text main-text--gradient-sequential">I am a student.</p></div>'
          : '<div class="realtalk2-text-above realtalk2-slot-two-lines" aria-hidden="true"><span class="realtalk2-text-placeholder"></span></div>';
        var realtalkHtml39 = '<div class="screen-content screen-content--step3-colors-no-frame">' +
          '<div class="realtalk2-layout realtalk-layout--reserve-go-space realtalk-layout--with-text-slots">' +
            '<div class="realtalk-top"><div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div></div>' +
            textAbove39 +
            '<div class="realtalk-main"><img src="./girl1.png" alt="" class="realtalk-main-image"></div>' +
            '<div class="realtalk2-text-below realtalk2-slot-two-lines" aria-hidden="true"><span class="realtalk2-text-placeholder"></span></div>' +
            '<div class="realtalk-bottom realtalk2-bottom--fixed-height">' +
              '<button type="button" class="mic-btn mic-btn--step3' + (turn39Playing ? ' realtalk2-mic--hidden' : '') + '" id="btn-mic-39" aria-label="Microphone">' + mic39Svg + '</button>' +
            '</div></div></div>';
        el.innerHTML = realtalkHtml39;
        var btn39 = document.getElementById('btn-mic-39');
        if (btn39 && !turn39Playing) btn39.onclick = function (e) {
          e.stopPropagation();
          startRecognition39(function () {
            if (turn39Phase === 0) {
              turn39Playing = true;
              mount();
              var a = new Audio('./realtalk3_x1.mp3');
              a.onended = a.onerror = function () { turn39Phase = 1; turn39Playing = false; mount(); };
              a.play().catch(function () { turn39Phase = 1; turn39Playing = false; mount(); });
            } else if (turn39Phase === 1) {
              turn39Playing = true;
              mount();
              var first = new Audio('./realtalk_x3.mp3');
              first.onended = function () {
                setTimeout(function () {
                  turn39ShowModelText = true;
                  mount();
                  var model = new Audio('./realtalk4_x1.mp3');
                  model.onended = model.onerror = function () { turn39ShowModelText = false; turn39Phase = 2; turn39Playing = false; mount(); };
                  model.play().catch(function () { turn39ShowModelText = false; turn39Phase = 2; turn39Playing = false; mount(); });
                }, 300);
              };
              first.onerror = function () { turn39Phase = 2; turn39Playing = false; mount(); };
              first.play().catch(function () { turn39Phase = 2; turn39Playing = false; mount(); });
            } else {
              turn39Playing = true;
              mount();
              var a2 = new Audio('./real5.mp3');
              a2.onended = a2.onerror = function () { turn39Phase = 0; turn39Playing = false; screenIndex = 40; mount(); };
              a2.play().catch(function () { turn39Phase = 0; turn39Playing = false; screenIndex = 40; mount(); });
            }
          });
        };
        return;
      }

      if (screenIndex === 40) {
        var step3Bg40 = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
        document.body.style.background = step3Bg40;
        document.documentElement.style.background = step3Bg40;
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) { appEl.style.background = step3Bg40; appEl.style.border = ''; appEl.style.boxShadow = 'none'; }
        if (overlayEl) overlayEl.innerHTML = '';
        var mic40Svg = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>';
        var realtalkHtml40 = '<div class="screen-content screen-content--step3-colors-no-frame">' +
          '<div class="realtalk2-layout realtalk-layout--reserve-go-space realtalk-layout--with-text-slots">' +
            '<div class="realtalk-top"><div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div></div>' +
            '<div class="realtalk2-text-above realtalk2-slot-two-lines" aria-hidden="true"><span class="realtalk2-text-placeholder"></span></div>' +
            '<div class="realtalk-main"><img src="./girl1.png" alt="" class="realtalk-main-image"></div>' +
            '<div class="realtalk2-text-below realtalk2-slot-two-lines" aria-hidden="true"><span class="realtalk2-text-placeholder"></span></div>' +
            '<div class="realtalk-bottom realtalk2-bottom--fixed-height">' +
              '<button type="button" class="mic-btn mic-btn--step3' + (turn40Playing ? ' realtalk2-mic--hidden' : '') + '" id="btn-mic-40" aria-label="Microphone">' + mic40Svg + '</button>' +
            '</div></div></div>';
        el.innerHTML = realtalkHtml40;
        var btn40 = document.getElementById('btn-mic-40');
        if (btn40 && !turn40Playing) btn40.onclick = function (e) {
          e.stopPropagation();
          startRecognition40(function () {
            turn40Playing = true;
            mount();
            var a = new Audio('./real7.mp3');
            var turn40StarScheduled = false;
            a.onended = function () {
              if (turn40StarScheduled) return;
              turn40StarScheduled = true;
              setTimeout(function () {
                turn40ShowStamp = true;
                playDingDong();
                mount();
              }, 2000);
            };
            a.onerror = function () { };
            a.play().catch(function () { });
          });
        };
        if (turn40ShowStamp) {
          var starPopupHtml = '<div class="checkmark-popup roleplay-complete-popup" role="button" tabindex="0" aria-label="완료" id="star-popup-40">' +
            '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">' +
              '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>' +
            '</svg></div>';
          el.insertAdjacentHTML('beforeend', starPopupHtml);
          var starEl = document.getElementById('star-popup-40');
          if (starEl) starEl.onclick = function (ev) { ev.stopPropagation(); goNext(); };
        }
        return;
      }

      if (screenIndex === 41) {
        var step3Bg41 = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
        document.body.style.background = step3Bg41;
        document.documentElement.style.background = step3Bg41;
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) { appEl.style.background = step3Bg41; appEl.style.border = ''; appEl.style.boxShadow = 'none'; }
        if (overlayEl) overlayEl.innerHTML = '';
        var realtalkHtml41 = '<div class="screen-content screen-content--step3-colors-no-frame">' +
          '<div class="realtalk-layout">' +
            '<div class="realtalk-top"><div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div></div>' +
            '<div class="realtalk-main">' +
              '<img src="./girl.png" alt="" class="realtalk-main-image">' +
            '</div>' +
            '<div class="realtalk-bottom"><button type="button" class="realtalk-go-btn' + (turn41ShowBtn ? '' : ' realtalk-go-btn--hidden') + '" id="realtalk-go-41">SURE!</button></div>' +
          '</div></div>';
        el.innerHTML = realtalkHtml41;
        var goBtn41 = document.getElementById('realtalk-go-41');
        if (goBtn41) goBtn41.onclick = function () { screenIndex = 42; mount(); };
        if (!turn41ShowBtn) {
          try {
            var audio41 = new Audio('./check.mp3');
            var turn41Cleared = false;
            var showBtn41 = function () { if (!turn41Cleared) { turn41ShowBtn = true; mount(); } };
            var onTimeUpdate = function () {
              if (turn41Cleared) return;
              if (audio41.duration && !isNaN(audio41.duration) && audio41.currentTime >= audio41.duration - 0.1) {
                audio41.removeEventListener('timeupdate', onTimeUpdate);
                showBtn41();
              }
            };
            var onEnded = function () {
              if (turn41Cleared) return;
              if (audio41.duration && !isNaN(audio41.duration) && audio41.currentTime >= audio41.duration - 0.1) {
                showBtn41();
                return;
              }
              setTimeout(function () {
                if (!turn41Cleared && audio41.duration && audio41.currentTime >= audio41.duration - 0.1) showBtn41();
              }, 200);
            };
            var onError = function () { setTimeout(showBtn41, 1500); };
            audio41.addEventListener('timeupdate', onTimeUpdate);
            audio41.addEventListener('ended', onEnded);
            audio41.addEventListener('error', onError);
            audio41.play().catch(onError);
          } catch (e) { setTimeout(function () { turn41ShowBtn = true; mount(); }, 1500); }
        }
        return;
      }

      if (screenIndex === 42) {
        var step3Bg42 = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
        document.body.style.background = step3Bg42;
        document.documentElement.style.background = step3Bg42;
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) { appEl.style.background = step3Bg42; appEl.style.border = ''; appEl.style.boxShadow = 'none'; }
        if (overlayEl) overlayEl.innerHTML = '';
        var globeSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><ellipse cx="12" cy="12" rx="10" ry="3"/><ellipse cx="12" cy="12" rx="3" ry="10"/></svg>';
        var soundSvg = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';
        var bubbles42 = '';
        for (var i = 0; i < turn42Script.length; i++) {
          var it = turn42Script[i];
          var isCathy = it.speaker === 'Cathy';
          var rowCls = isCathy ? 'roleplay-bubble-row roleplay-bubble-row--character' : 'roleplay-bubble-row roleplay-bubble-row--student';
          var avatarSrc = isCathy ? './girl.png' : './student.png';
          var avatarCls = isCathy ? 'roleplay-avatar' : 'roleplay-avatar roleplay-avatar--student';
          var bubbleCls = isCathy ? 'roleplay-bubble roleplay-bubble--character' : 'roleplay-bubble roleplay-bubble--student';
          if (it.singleLine) bubbleCls += ' roleplay-bubble--single-line';
          var text = turn42ShowKo[i] ? it.textKo : it.textEn;
          var soundDisabled = it.audio ? '' : ' disabled';
          bubbles42 += '<div class="' + rowCls + '">' +
            '<img src="' + avatarSrc + '" alt="" class="' + avatarCls + '" aria-hidden="true">' +
            '<div class="' + wrapCls + '">' +
              '<span class="roleplay-name">' + it.speaker + '</span>' +
              '<div class="' + bubbleCls + '">' + text + '</div>' +
              '<div class="roleplay-bubble-actions">' +
                '<button type="button" class="roleplay-k-btn" id="btn-42-ko-' + i + '" aria-label="' + (turn42ShowKo[i] ? '영어로 보기' : '한글로 보기') + '">' + globeSvg + '</button>' +
                '<button type="button" class="roleplay-k-btn roleplay-sound-btn" id="btn-42-sound-' + i + '" aria-label="' + (it.audio ? '소리' : '소리 없음') + '"' + soundDisabled + '>' + soundSvg + '</button>' +
              '</div></div></div>';
        }
        var checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 13l4 4L19 7"/></svg>';
        var realtalkHtml42 = '<div class="screen-content screen-content--step3-colors-no-frame">' +
          '<div class="realtalk2-layout realtalk-layout--reserve-go-space">' +
            '<div class="realtalk-top"><div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div></div>' +
            '<div class="realtalk-main realtalk2-main--roleplay-chat">' +
              '<div class="roleplay-chat">' + bubbles42 +
                '<div class="roleplay-chat-bottom">' +
                  '<button type="button" class="roleplay-check-btn" id="btn-42-check" aria-label="다음으로">' + checkSvg + '</button>' +
                '</div></div>' +
            '</div>' +
          '</div></div>';
        el.innerHTML = realtalkHtml42;
        var btn42Check = document.getElementById('btn-42-check');
        if (btn42Check) btn42Check.onclick = goNext;
        for (var j = 0; j < turn42Script.length; j++) {
          (function (idx) {
            var btnKo = document.getElementById('btn-42-ko-' + idx);
            if (btnKo) btnKo.onclick = function () { turn42ShowKo[idx] = !turn42ShowKo[idx]; mount(); };
            var btnSound = document.getElementById('btn-42-sound-' + idx);
            if (btnSound && turn42Script[idx].audio) {
              btnSound.onclick = function () {
                try { var a = new Audio(turn42Script[idx].audio); a.play().catch(function () {}); } catch (e) {}
              };
            }
          })(j);
        }
        return;
      }

      if (screenIndex === 43) {
        var step3Bg43 = 'linear-gradient(135deg, #f8bbd0 0%, #e1bee7 50%, #7986cb 100%)';
        document.body.style.background = step3Bg43;
        document.documentElement.style.background = step3Bg43;
        if (header) { header.style.display = ''; header.className = 'app-header app-header--step3'; }
        if (appEl) { appEl.style.background = step3Bg43; appEl.style.border = ''; appEl.style.boxShadow = 'none'; }
        if (overlayEl) overlayEl.innerHTML = '';
        el.innerHTML = '<div class="screen-content screen-content--step3-colors-no-frame" data-screen="43">' +
          '<div class="realtalk2-layout">' +
            '<div class="realtalk-top"><div class="topic-box topic-box--step3">' + TOPIC_TEXT + '</div></div>' +
            '<div class="realtalk-main"><p style="text-align:center;color:#5c6bc0;">Screen 43</p></div>' +
          '</div></div>';
        return;
      }

      el.innerHTML = renderScreen2(screen2State, goNext);
      playPop();

      var btnMic = document.getElementById('btn-mic');
      if (btnMic) btnMic.onclick = startRecognition;
    }

    // Initial render – Screen 1: tap to start audio (screen1-1, then screen1-2)
    mount();
  </script>
</body>
</html>
